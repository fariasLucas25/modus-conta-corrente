<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modus ¬∑ An√°lise de Conta Corrente</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

<style>
  :root {
    --ink: #0e0e10;
    --paper: #f5f2eb;
    --cream: #ede9df;
    --gold: #c8a84b;
    --gold-light: #e8d48a;
    --red: #c0392b;
    --green: #1a6b3a;
    --muted: #7a7670;
    --border: #d4cfc4;
    --card: #ffffff;
    --shadow: 0 2px 16px rgba(14,14,16,0.08);
    --shadow-lg: 0 8px 40px rgba(14,14,16,0.14);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Syne', sans-serif;
    background: var(--paper);
    color: var(--ink);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    background: var(--ink);
    color: var(--paper);
    padding: 0 2.5rem;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 2px solid var(--gold);
  }
  .logo {
    font-family: 'DM Serif Display', serif;
    font-size: 1.35rem;
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .logo span { color: var(--gold); }
  .logo-sub {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-left: 0.75rem;
    padding-left: 0.75rem;
    border-left: 1px solid #333;
  }
  .header-right {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  .api-key-wrap {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .api-key-wrap label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }
  #apiKeyInput {
    background: #1a1a1c;
    border: 1px solid #333;
    color: var(--paper);
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    padding: 0.35rem 0.7rem;
    border-radius: 4px;
    width: 220px;
    outline: none;
    transition: border-color 0.2s;
  }
  #apiKeyInput:focus { border-color: var(--gold); }
  .badge-api {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #555;
    transition: background 0.3s;
  }
  .badge-api.active { background: #22c55e; box-shadow: 0 0 6px #22c55e; }

  /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
  .app-layout {
    display: grid;
    grid-template-columns: 260px 1fr;
    min-height: calc(100vh - 60px);
  }

  /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
  aside {
    background: var(--ink);
    color: var(--paper);
    padding: 1.5rem 1rem;
    border-right: 1px solid #1e1e20;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  .sidebar-section {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: #555;
    padding: 1rem 0.5rem 0.5rem;
  }
  .nav-item {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    padding: 0.55rem 0.75rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.82rem;
    font-weight: 600;
    color: #aaa;
    transition: all 0.15s;
    border: 1px solid transparent;
  }
  .nav-item:hover { background: #1a1a1c; color: var(--paper); }
  .nav-item.active { background: #1a1a1c; color: var(--gold); border-color: #2a2a2c; }
  .nav-icon { font-size: 0.9rem; width: 18px; text-align: center; }

  .case-list { margin-top: 0.5rem; flex: 1; overflow-y: auto; }
  .case-item {
    padding: 0.6rem 0.75rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.75rem;
    color: #888;
    border: 1px solid transparent;
    transition: all 0.15s;
    margin-bottom: 0.2rem;
  }
  .case-item:hover { background: #1a1a1c; color: var(--paper); }
  .case-item.active { background: #1a1a1c; border-color: var(--gold); color: var(--gold); }
  .case-item-name { font-weight: 600; color: inherit; margin-bottom: 0.15rem; }
  .case-item-meta { font-family: 'DM Mono', monospace; font-size: 0.6rem; color: #555; }
  .case-item.active .case-item-meta { color: #888; }

  .btn-new-case {
    margin-top: 0.5rem;
    width: 100%;
    padding: 0.6rem;
    background: transparent;
    border: 1px dashed #333;
    color: #555;
    border-radius: 6px;
    font-family: 'Syne', sans-serif;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.15s;
  }
  .btn-new-case:hover { border-color: var(--gold); color: var(--gold); }

  /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
  main {
    padding: 2rem 2.5rem;
    overflow-y: auto;
    max-height: calc(100vh - 60px);
  }

  /* ‚îÄ‚îÄ PAGE TITLE ‚îÄ‚îÄ */
  .page-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border);
  }
  .page-title {
    font-family: 'DM Serif Display', serif;
    font-size: 2rem;
    font-weight: 400;
    line-height: 1.1;
    letter-spacing: -0.03em;
  }
  .page-title em { color: var(--gold); font-style: italic; }
  .page-subtitle {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 0.08em;
    margin-top: 0.4rem;
    text-transform: uppercase;
  }

  /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: var(--shadow);
  }
  .card-title {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--muted);
    margin-bottom: 1rem;
  }

  /* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.25rem; }
  .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }

  /* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1.25rem 1.5rem;
    position: relative;
    overflow: hidden;
  }
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: var(--gold);
  }
  .stat-card.danger::before { background: var(--red); }
  .stat-card.success::before { background: var(--green); }
  .stat-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--muted);
    margin-bottom: 0.5rem;
  }
  .stat-value {
    font-family: 'DM Serif Display', serif;
    font-size: 1.6rem;
    letter-spacing: -0.03em;
    line-height: 1;
  }
  .stat-value.negative { color: var(--red); }
  .stat-value.positive { color: var(--green); }
  .stat-delta {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    margin-top: 0.4rem;
  }

  /* ‚îÄ‚îÄ UPLOAD ZONE ‚îÄ‚îÄ */
  .upload-zone {
    border: 2px dashed var(--border);
    border-radius: 10px;
    padding: 3rem 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--cream);
    position: relative;
  }
  .upload-zone:hover, .upload-zone.dragover {
    border-color: var(--gold);
    background: #fdf9ef;
  }
  .upload-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .upload-icon { font-size: 2.5rem; margin-bottom: 1rem; }
  .upload-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.1rem;
    margin-bottom: 0.4rem;
  }
  .upload-hint {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    letter-spacing: 0.05em;
  }
  .upload-badges { display: flex; justify-content: center; gap: 0.5rem; margin-top: 0.75rem; }
  .badge {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    padding: 0.2rem 0.5rem;
    border-radius: 3px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }
  .badge-gold { background: #fdf3d0; color: #8a6d1a; border: 1px solid #e8d48a; }
  .badge-blue { background: #e8f0fe; color: #1a4a8a; border: 1px solid #a8c0f0; }
  .badge-green { background: #e8f5ee; color: #1a6b3a; border: 1px solid #a8d4b8; }

  /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.65rem 1.25rem;
    border-radius: 6px;
    font-family: 'Syne', sans-serif;
    font-size: 0.82rem;
    font-weight: 700;
    cursor: pointer;
    border: none;
    transition: all 0.15s;
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }
  .btn-primary {
    background: var(--ink);
    color: var(--paper);
  }
  .btn-primary:hover { background: #1e1e20; }
  .btn-gold {
    background: var(--gold);
    color: var(--ink);
  }
  .btn-gold:hover { background: var(--gold-light); }
  .btn-outline {
    background: transparent;
    color: var(--ink);
    border: 1.5px solid var(--border);
  }
  .btn-outline:hover { border-color: var(--ink); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
  .table-wrap { overflow-x: auto; }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8rem;
  }
  th {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--muted);
    padding: 0.6rem 1rem;
    border-bottom: 2px solid var(--border);
    text-align: left;
    white-space: nowrap;
  }
  td {
    padding: 0.6rem 1rem;
    border-bottom: 1px solid var(--cream);
    vertical-align: middle;
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--cream); }
  .td-num { font-family: 'DM Mono', monospace; text-align: right; }
  .td-neg { color: var(--red); font-family: 'DM Mono', monospace; text-align: right; }
  .td-pos { color: var(--green); font-family: 'DM Mono', monospace; text-align: right; }

  /* ‚îÄ‚îÄ CHAT / AI ‚îÄ‚îÄ */
  .chat-wrap {
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 480px;
    background: var(--card);
  }
  .chat-header {
    background: var(--ink);
    color: var(--paper);
    padding: 0.75rem 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .chat-header-title {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }
  .chat-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--gold); }
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .msg {
    max-width: 85%;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-size: 0.82rem;
    line-height: 1.5;
  }
  .msg-ai {
    background: var(--cream);
    border: 1px solid var(--border);
    align-self: flex-start;
    border-bottom-left-radius: 2px;
  }
  .msg-user {
    background: var(--ink);
    color: var(--paper);
    align-self: flex-end;
    border-bottom-right-radius: 2px;
  }
  .msg-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.58rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--muted);
    margin-bottom: 0.3rem;
  }
  .msg-user .msg-label { color: #888; }
  .chat-input-wrap {
    padding: 1rem;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 0.5rem;
  }
  #chatInput {
    flex: 1;
    padding: 0.65rem 1rem;
    border: 1.5px solid var(--border);
    border-radius: 6px;
    font-family: 'Syne', sans-serif;
    font-size: 0.82rem;
    outline: none;
    background: var(--paper);
    transition: border-color 0.2s;
  }
  #chatInput:focus { border-color: var(--gold); }

  /* ‚îÄ‚îÄ PROGRESS / LOADING ‚îÄ‚îÄ */
  .progress-bar-wrap {
    height: 4px;
    background: var(--cream);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 0.5rem;
  }
  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--gold), var(--gold-light));
    border-radius: 2px;
    transition: width 0.4s;
  }
  .loading-spinner {
    display: inline-block;
    width: 14px; height: 14px;
    border: 2px solid var(--border);
    border-top-color: var(--gold);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
  .tabs { display: flex; gap: 0; border-bottom: 2px solid var(--border); margin-bottom: 1.5rem; }
  .tab {
    padding: 0.6rem 1.25rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    cursor: pointer;
    color: var(--muted);
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .tab:hover { color: var(--ink); }
  .tab.active { color: var(--ink); border-bottom-color: var(--gold); font-weight: 600; }

  /* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
  .form-group { display: flex; flex-direction: column; gap: 0.4rem; }
  .form-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--muted);
  }
  .form-input {
    padding: 0.6rem 0.85rem;
    border: 1.5px solid var(--border);
    border-radius: 6px;
    font-family: 'Syne', sans-serif;
    font-size: 0.85rem;
    background: var(--paper);
    outline: none;
    transition: border-color 0.2s;
  }
  .form-input:focus { border-color: var(--gold); }
  select.form-input { cursor: pointer; }

  /* ‚îÄ‚îÄ ANALYSIS RESULT ‚îÄ‚îÄ */
  .result-section { animation: fadeInUp 0.4s ease; }
  @keyframes fadeInUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }

  .result-highlight {
    background: linear-gradient(135deg, #fdf9ef 0%, #fff 100%);
    border: 1.5px solid var(--gold);
    border-radius: 10px;
    padding: 1.5rem 2rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 2rem;
  }
  .result-highlight-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--muted);
    margin-bottom: 0.5rem;
  }
  .result-highlight-value {
    font-family: 'DM Serif Display', serif;
    font-size: 2.8rem;
    color: var(--red);
    letter-spacing: -0.04em;
    line-height: 1;
  }

  /* ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ */
  .view { display: none; }
  .view.active { display: block; }

  /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--muted);
  }
  .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.4; }
  .empty-state-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.25rem;
    color: var(--ink);
    margin-bottom: 0.5rem;
  }
  .empty-state-text { font-size: 0.82rem; line-height: 1.5; }

  /* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* ‚îÄ‚îÄ NOTIFICATION ‚îÄ‚îÄ */
  .toast {
    position: fixed;
    bottom: 1.5rem; right: 1.5rem;
    background: var(--ink);
    color: var(--paper);
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    font-size: 0.82rem;
    border-left: 3px solid var(--gold);
    animation: slideIn 0.3s ease;
    z-index: 999;
    max-width: 320px;
  }
  .toast.error { border-left-color: var(--red); }
  .toast.success { border-left-color: var(--green); }
  @keyframes slideIn { from { transform: translateX(100%); opacity:0; } to { transform:translateX(0); opacity:1; } }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(14,14,16,0.65);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 200;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--card);
    border-radius: 12px;
    padding: 2rem;
    max-width: 520px;
    width: 90%;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-lg);
    animation: fadeInUp 0.25s ease;
  }
  .modal-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.4rem;
    margin-bottom: 1.25rem;
  }
  .modal-actions { display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem; }

  /* ‚îÄ‚îÄ STATUS BADGE ‚îÄ‚îÄ */
  .status {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.2rem 0.6rem;
    border-radius: 20px;
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }
  .status-dot { width: 5px; height: 5px; border-radius: 50%; }
  .status-pending { background: #fef9e7; color: #8a6d1a; }
  .status-pending .status-dot { background: var(--gold); }
  .status-done { background: #e8f5ee; color: #1a6b3a; }
  .status-done .status-dot { background: var(--green); }
  .status-error { background: #fef0ee; color: #8a1a1a; }
  .status-error .status-dot { background: var(--red); }

  .section-gap { margin-bottom: 1.5rem; }

  /* ‚îÄ‚îÄ CHART CONTAINER ‚îÄ‚îÄ */
  .chart-container { position: relative; height: 260px; }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">
    <span>Modus</span>
    <div class="logo-sub">Conta Corrente ¬∑ An√°lise Pericial</div>
  </div>
  <div class="header-right">
    <div class="api-key-wrap">
      <label>Chave API Claude</label>
      <input type="password" id="apiKeyInput" placeholder="sk-ant-..." oninput="onApiKeyChange(this.value)">
      <div class="badge-api" id="apiBadge"></div>
    </div>
  </div>
</header>

<!-- LAYOUT -->
<div class="app-layout">

  <!-- SIDEBAR -->
  <aside>
    <div class="sidebar-section">Navega√ß√£o</div>
    <div class="nav-item active" onclick="showView('dashboard')" id="nav-dashboard">
      <span class="nav-icon">‚ñ¶</span> Dashboard
    </div>
    <div class="nav-item" onclick="showView('novo')" id="nav-novo">
      <span class="nav-icon">Ôºã</span> Novo Caso
    </div>
    <div class="nav-item" onclick="showView('consulta')" id="nav-consulta">
      <span class="nav-icon">‚óâ</span> An√°lise I.A.
    </div>

    <div class="sidebar-section">Casos Ativos</div>
    <div class="case-list" id="caseList">
      <div style="font-family:'DM Mono',monospace;font-size:0.65rem;color:#444;padding:0.5rem;">
        Nenhum caso cadastrado
      </div>
    </div>
    <button class="btn-new-case" onclick="showView('novo')">+ Novo Caso</button>
  </aside>

  <!-- MAIN -->
  <main>

    <!-- ‚îÄ‚îÄ VIEW: DASHBOARD ‚îÄ‚îÄ -->
    <div class="view active" id="view-dashboard">
      <div class="page-header">
        <div>
          <div class="page-title">Painel <em>Geral</em></div>
          <div class="page-subtitle">Vis√£o consolidada ¬∑ Todos os casos</div>
        </div>
        <button class="btn btn-gold" onclick="showView('novo')">+ Novo Caso</button>
      </div>

      <div class="grid-4 section-gap" id="dashStats">
        <div class="stat-card">
          <div class="stat-label">Total de Casos</div>
          <div class="stat-value" id="ds-total">0</div>
          <div class="stat-delta">cadastrados</div>
        </div>
        <div class="stat-card danger">
          <div class="stat-label">Cobrado Total</div>
          <div class="stat-value negative" id="ds-cobrado">R$ 0</div>
          <div class="stat-delta">pelo banco</div>
        </div>
        <div class="stat-card success">
          <div class="stat-label">Valor L√≠cito Total</div>
          <div class="stat-value positive" id="ds-licito">R$ 0</div>
          <div class="stat-delta">conforme BACEN</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Diferen√ßa Total</div>
          <div class="stat-value negative" id="ds-diff">R$ 0</div>
          <div class="stat-delta">a ser restitu√≠do</div>
        </div>
      </div>

      <div class="grid-2 section-gap">
        <div class="card">
          <div class="card-title">Evolu√ß√£o por Caso ¬∑ Diferen√ßa Apurada</div>
          <div class="chart-container">
            <canvas id="chartCasos"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Status dos Casos</div>
          <div class="chart-container">
            <canvas id="chartStatus"></canvas>
          </div>
        </div>
      </div>

      <div class="card" id="dashCasosTable">
        <div class="card-title">Todos os Casos</div>
        <div class="empty-state">
          <div class="empty-state-icon">üìÇ</div>
          <div class="empty-state-title">Nenhum caso ainda</div>
          <div class="empty-state-text">Clique em "Novo Caso" para importar um extrato banc√°rio e iniciar a an√°lise pericial.</div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ VIEW: NOVO CASO ‚îÄ‚îÄ -->
    <div class="view" id="view-novo">
      <div class="page-header">
        <div>
          <div class="page-title">Novo <em>Caso</em></div>
          <div class="page-subtitle">Importar extrato e configurar par√¢metros</div>
        </div>
      </div>

      <div class="card section-gap">
        <div class="card-title">1. Dados do Caso</div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">N√∫mero do Processo</label>
            <input class="form-input" id="f-processo" placeholder="0000000-00.0000.0.00.0000">
          </div>
          <div class="form-group">
            <label class="form-label">Cliente / Parte</label>
            <input class="form-input" id="f-cliente" placeholder="Nome completo do cliente">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Banco</label>
            <select class="form-input" id="f-banco">
              <option value="">Selecione o banco</option>
              <option>Banco do Brasil</option>
              <option>Caixa Econ√¥mica Federal</option>
              <option>Bradesco</option>
              <option>Ita√∫</option>
              <option>Santander</option>
              <option>Nubank</option>
              <option>Outro</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Tipo de An√°lise</label>
            <select class="form-input" id="f-tipo">
              <option value="anatocismo">Anatocismo (Cheque Especial)</option>
              <option value="bacen">Taxa BACEN S√©rie 20741</option>
              <option value="completo">An√°lise Completa (Ambas)</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Data In√≠cio do Extrato</label>
            <input class="form-input" type="date" id="f-inicio">
          </div>
          <div class="form-group">
            <label class="form-label">Data Fim do Extrato</label>
            <input class="form-input" type="date" id="f-fim">
          </div>
        </div>
      </div>

      <div class="card section-gap">
        <div class="card-title">2. Importar Extrato Banc√°rio</div>
        <div class="upload-zone" id="uploadZone">
          <input type="file" id="fileInput" accept=".xlsx,.xls,.csv,.pdf" onchange="handleFile(this.files[0])">
          <div class="upload-icon">üìÑ</div>
          <div class="upload-title">Arraste o arquivo aqui ou clique para selecionar</div>
          <div class="upload-hint">Extrato exportado do internet banking ou sistema judicial</div>
          <div class="upload-badges">
            <span class="badge badge-gold">XLSX</span>
            <span class="badge badge-gold">XLS</span>
            <span class="badge badge-gold">CSV</span>
            <span class="badge badge-blue">PDF</span>
          </div>
        </div>
        <div id="fileStatus" style="display:none;margin-top:1rem;">
          <div style="display:flex;align-items:center;gap:0.75rem;padding:0.75rem 1rem;background:var(--cream);border-radius:6px;border:1px solid var(--border);">
            <span style="font-size:1.2rem;">üìã</span>
            <div>
              <div style="font-weight:600;font-size:0.85rem;" id="fileName"></div>
              <div style="font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--muted);" id="fileInfo"></div>
            </div>
            <div style="margin-left:auto;">
              <span class="status status-pending"><span class="status-dot"></span>Aguardando</span>
            </div>
          </div>
        </div>
        <div id="previewWrap" style="display:none;margin-top:1rem;">
          <div class="card-title" style="margin-bottom:0.75rem;">Pr√©-visualiza√ß√£o dos dados importados</div>
          <div class="table-wrap">
            <table id="previewTable"></table>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:1rem;justify-content:flex-end;">
        <button class="btn btn-outline" onclick="showView('dashboard')">Cancelar</button>
        <button class="btn btn-gold" id="btnAnalisar" onclick="analisarCaso()" disabled>
          ‚ö° Analisar com I.A.
        </button>
      </div>

      <!-- PROCESSING -->
      <div id="processingWrap" style="display:none;margin-top:1.5rem;" class="card">
        <div class="card-title">Processamento em andamento</div>
        <div id="processingSteps"></div>
      </div>

      <!-- RESULT -->
      <div id="resultWrap" style="display:none;margin-top:1.5rem;" class="result-section">
        <div class="result-highlight">
          <div>
            <div class="result-highlight-label">Diferen√ßa Apurada ¬∑ Valor a Restituir</div>
            <div class="result-highlight-value" id="r-diferenca">‚Äî</div>
            <div style="font-family:'DM Mono',monospace;font-size:0.68rem;color:var(--muted);margin-top:0.5rem;" id="r-periodo"></div>
          </div>
          <div style="display:flex;gap:2rem;">
            <div>
              <div class="result-highlight-label">Cobrado pelo Banco</div>
              <div style="font-family:'DM Serif Display',serif;font-size:1.5rem;color:var(--red);" id="r-cobrado">‚Äî</div>
            </div>
            <div>
              <div class="result-highlight-label">Valor L√≠cito (BACEN)</div>
              <div style="font-family:'DM Serif Display',serif;font-size:1.5rem;color:var(--green);" id="r-licito">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="tabs">
          <div class="tab active" onclick="switchResultTab(this,'tab-resumo')">Resumo Mensal</div>
          <div class="tab" onclick="switchResultTab(this,'tab-analise')">An√°lise I.A.</div>
          <div class="tab" onclick="switchResultTab(this,'tab-grafico')">Gr√°fico</div>
        </div>

        <div id="tab-resumo" class="card">
          <div class="table-wrap">
            <table id="resultTable"></table>
          </div>
        </div>
        <div id="tab-analise" class="card" style="display:none;">
          <div id="aiAnalysis" style="font-size:0.85rem;line-height:1.7;white-space:pre-wrap;"></div>
        </div>
        <div id="tab-grafico" class="card" style="display:none;">
          <div class="chart-container">
            <canvas id="chartResult"></canvas>
          </div>
        </div>

        <div style="display:flex;gap:0.75rem;margin-top:1rem;">
          <button class="btn btn-primary" onclick="exportarResultado()">‚¨á Exportar Relat√≥rio Excel</button>
          <button class="btn btn-outline" onclick="salvarCaso()">üíæ Salvar Caso</button>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ VIEW: CONSULTA I.A. ‚îÄ‚îÄ -->
    <div class="view" id="view-consulta">
      <div class="page-header">
        <div>
          <div class="page-title">An√°lise <em>I.A.</em></div>
          <div class="page-subtitle">Consulte a IA sobre qualquer caso ou conceito jur√≠dico</div>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <div class="chat-wrap">
            <div class="chat-header">
              <div class="chat-dot"></div>
              <div class="chat-header-title">Assistente Jur√≠dico ¬∑ Conta Corrente</div>
            </div>
            <div class="chat-messages" id="chatMessages">
              <div class="msg msg-ai">
                <div class="msg-label">Assistente Modus</div>
                Ol√°! Sou o assistente especializado em an√°lise de conta corrente e cheque especial. Posso ajudar com:<br><br>
                ‚Ä¢ C√°lculo de anatocismo<br>
                ‚Ä¢ Interpreta√ß√£o de taxas BACEN<br>
                ‚Ä¢ Revis√£o de encargos cobrados<br>
                ‚Ä¢ Fundamenta√ß√£o jur√≠dica<br><br>
                Selecione um caso na lateral ou fa√ßa uma pergunta diretamente.
              </div>
            </div>
            <div class="chat-input-wrap">
              <input type="text" id="chatInput" placeholder="Pergunte sobre anatocismo, taxas BACEN, encargos..." onkeydown="if(event.key==='Enter')sendChat()">
              <button class="btn btn-primary" onclick="sendChat()">Enviar</button>
            </div>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;gap:1rem;">
          <div class="card">
            <div class="card-title">Caso em An√°lise</div>
            <select class="form-input" id="chatCaseSelect" onchange="loadCaseContext()">
              <option value="">Nenhum caso selecionado</option>
            </select>
            <div id="chatCaseSummary" style="margin-top:1rem;display:none;">
              <div style="font-size:0.82rem;line-height:1.6;" id="chatCaseSummaryText"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-title">Sugest√µes de Perguntas</div>
            <div style="display:flex;flex-direction:column;gap:0.5rem;">
              <div class="suggestion" onclick="setSuggestion(this)">Qual √© o fundamento jur√≠dico para cobran√ßa de anatocismo em cheque especial?</div>
              <div class="suggestion" onclick="setSuggestion(this)">Como calcular a diferen√ßa entre a taxa cobrada e a taxa BACEN S√©rie 20741?</div>
              <div class="suggestion" onclick="setSuggestion(this)">O banco pode cobrar juros sobre juros vencidos em conta corrente?</div>
              <div class="suggestion" onclick="setSuggestion(this)">Explique o c√°lculo de juros compensados no m√©todo sem anatocismo.</div>
              <div class="suggestion" onclick="setSuggestion(this)">Qual √© o prazo prescricional para a√ß√£o de revis√£o de cheque especial?</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ VIEW: CASO INDIVIDUAL ‚îÄ‚îÄ -->
    <div class="view" id="view-caso">
      <div class="page-header">
        <div>
          <div class="page-title" id="caso-title">Caso</div>
          <div class="page-subtitle" id="caso-subtitle"></div>
        </div>
        <div style="display:flex;gap:0.75rem;">
          <button class="btn btn-outline" onclick="showView('consulta')">ü§ñ Consultar I.A.</button>
          <button class="btn btn-primary" onclick="exportarResultado()">‚¨á Exportar</button>
        </div>
      </div>
      <div id="casoContent"></div>
    </div>

  </main>
</div>

<!-- MODAL NOVO CASO -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-title">Caso salvo com sucesso</div>
    <p style="font-size:0.85rem;line-height:1.6;color:var(--muted);">O caso foi adicionado ao painel. Voc√™ pode acess√°-lo a qualquer momento pelo menu lateral.</p>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal()">Fechar</button>
      <button class="btn btn-gold" onclick="closeModal();showView('dashboard')">Ver Painel</button>
    </div>
  </div>
</div>

<style>
  .suggestion {
    padding: 0.6rem 0.85rem;
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.78rem;
    cursor: pointer;
    transition: all 0.15s;
    line-height: 1.4;
  }
  .suggestion:hover { border-color: var(--gold); background: #fdf9ef; }
</style>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let state = {
  apiKey: '',
  cases: [],
  currentCase: null,
  parsedData: null,
  chartCasos: null,
  chartStatus: null,
  chartResult: null,
  chatHistory: []
};

// Load from localStorage
try {
  const saved = localStorage.getItem('modus_cases');
  if (saved) state.cases = JSON.parse(saved);
} catch(e) {}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API KEY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onApiKeyChange(val) {
  state.apiKey = val.trim();
  document.getElementById('apiBadge').className = 'badge-api' + (val.startsWith('sk-ant-') ? ' active' : '');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const v = document.getElementById('view-'+name);
  if (v) v.classList.add('active');
  const n = document.getElementById('nav-'+name);
  if (n) n.classList.add('active');
  if (name === 'dashboard') renderDashboard();
  if (name === 'consulta') populateCaseSelect();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILE HANDLING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const uploadZone = document.getElementById('uploadZone');
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', e => {
  e.preventDefault();
  uploadZone.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) handleFile(file);
});

async function handleFile(file) {
  if (!file) return;
  document.getElementById('fileStatus').style.display = 'block';
  document.getElementById('fileName').textContent = file.name;
  document.getElementById('fileInfo').textContent = `${(file.size/1024).toFixed(1)} KB ¬∑ ${file.type || 'arquivo'}`;

  const ext = file.name.split('.').pop().toLowerCase();
  try {
    if (ext === 'pdf') {
      state.parsedData = await parsePDF(file);
    } else {
      state.parsedData = await parseExcel(file);
    }
    showPreview(state.parsedData);
    document.getElementById('btnAnalisar').disabled = false;
    toast('Arquivo importado com sucesso!', 'success');
  } catch(e) {
    toast('Erro ao importar: ' + e.message, 'error');
  }
}

async function parseExcel(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const wb = XLSX.read(e.target.result, { type:'binary', cellDates:true });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, { header:1, defval:'' });
        // Find header row
        let headerIdx = 0;
        for (let i = 0; i < Math.min(10, json.length); i++) {
          const row = json[i];
          const hasDate = row.some(c => String(c).match(/data|date/i));
          const hasVal = row.some(c => String(c).match(/saldo|valor|d√©bito|cr√©dito|movement/i));
          if (hasDate || hasVal) { headerIdx = i; break; }
        }
        const headers = json[headerIdx].map((h,i) => h || `Col${i+1}`);
        const rows = json.slice(headerIdx+1).filter(r => r.some(c => c !== ''));
        resolve({ headers, rows, source: file.name, type: 'excel' });
      } catch(err) { reject(err); }
    };
    reader.readAsBinaryString(file);
  });
}

async function parsePDF(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = async e => {
      try {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        const pdf = await pdfjsLib.getDocument({ data: e.target.result }).promise;
        let fullText = '';
        for (let i = 1; i <= Math.min(pdf.numPages, 20); i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          const pageText = content.items.map(item => item.str).join(' ');
          fullText += pageText + '\n';
        }
        // Parse structured rows from text
        const lines = fullText.split('\n').filter(l => l.trim());
        const dateRegex = /\d{2}[\/\-\.]\d{2}[\/\-\.]\d{2,4}/;
        const valueRegex = /-?[\d\.]+,\d{2}/;
        const rows = [];
        for (const line of lines) {
          if (dateRegex.test(line) && valueRegex.test(line)) {
            const dateMatch = line.match(dateRegex);
            const values = line.match(/-?[\d\.]+,\d{2}/g) || [];
            rows.push([dateMatch[0], line.replace(dateRegex,'').replace(/-?[\d\.]+,\d{2}/g,'').trim().substring(0,40), ...values]);
          }
        }
        resolve({
          headers: ['Data','Hist√≥rico','Valor','Saldo'],
          rows: rows.slice(0,200),
          source: file.name,
          type: 'pdf',
          rawText: fullText.substring(0, 8000)
        });
      } catch(err) { reject(err); }
    };
    reader.readAsArrayBuffer(file);
  });
}

function showPreview(data) {
  const wrap = document.getElementById('previewWrap');
  wrap.style.display = 'block';
  const table = document.getElementById('previewTable');
  const maxRows = 8;
  let html = '<thead><tr>' + data.headers.map(h=>`<th>${h}</th>`).join('') + '</tr></thead><tbody>';
  for (let i = 0; i < Math.min(maxRows, data.rows.length); i++) {
    html += '<tr>' + data.headers.map((_,j) => `<td>${data.rows[i][j] ?? ''}</td>`).join('') + '</tr>';
  }
  if (data.rows.length > maxRows) {
    html += `<tr><td colspan="${data.headers.length}" style="text-align:center;font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--muted);padding:0.75rem;">... e mais ${data.rows.length - maxRows} linhas</td></tr>`;
  }
  html += '</tbody>';
  table.innerHTML = html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ANALYSIS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function analisarCaso() {
  if (!state.parsedData) return toast('Importe um arquivo primeiro.', 'error');

  const processo = document.getElementById('f-processo').value;
  const cliente = document.getElementById('f-cliente').value;
  const banco = document.getElementById('f-banco').value;
  const tipo = document.getElementById('f-tipo').value;

  if (!cliente) return toast('Informe o nome do cliente.', 'error');

  document.getElementById('processingWrap').style.display = 'block';
  document.getElementById('resultWrap').style.display = 'none';
  document.getElementById('btnAnalisar').disabled = true;
  document.getElementById('btnAnalisar').innerHTML = '<span class="loading-spinner"></span> Analisando...';

  const steps = [
    { id: 's1', label: 'Estruturando dados do extrato' },
    { id: 's2', label: 'Calculando m√©dias mensais de saldo' },
    { id: 's3', label: 'Apurando encargos cobrados' },
    { id: 's4', label: 'Recalculando sem anatocismo' },
    { id: 's5', label: 'Comparando com taxa BACEN S√©rie 20741' },
    { id: 's6', label: 'Gerando an√°lise jur√≠dica com I.A.' },
  ];

  renderSteps(steps);

  try {
    // Simulate and process
    await delay(600); markStep('s1', true);
    await delay(500); markStep('s2', true);
    await delay(600); markStep('s3', true);
    await delay(700); markStep('s4', true);

    // Simulate financial calculation
    const result = calculateMockResult(state.parsedData, tipo);
    await delay(400); markStep('s5', true);

    // AI Analysis
    let aiText = '';
    if (state.apiKey && state.apiKey.startsWith('sk-ant-')) {
      aiText = await getAIAnalysis(result, cliente, banco, tipo, state.parsedData);
    } else {
      aiText = gerarAnaliseDemo(result, cliente, banco, tipo);
    }
    markStep('s6', true);

    result.aiAnalysis = aiText;
    result.processo = processo;
    result.cliente = cliente;
    result.banco = banco;
    result.tipo = tipo;
    result.dataAnalise = new Date().toLocaleDateString('pt-BR');

    state.currentCase = result;
    renderResult(result);

  } catch(e) {
    toast('Erro na an√°lise: ' + e.message, 'error');
    console.error(e);
  }

  document.getElementById('btnAnalisar').disabled = false;
  document.getElementById('btnAnalisar').innerHTML = '‚ö° Analisar com I.A.';
}

function calculateMockResult(data, tipo) {
  // Extract numeric values from parsed data
  const rows = data.rows;
  const monthlyData = {};

  // Try to extract saldo values
  let values = [];
  for (const row of rows) {
    for (const cell of row) {
      const str = String(cell).replace(/\./g,'').replace(',','.');
      const num = parseFloat(str);
      if (!isNaN(num) && Math.abs(num) > 1 && Math.abs(num) < 500000) values.push(num);
    }
  }

  // Generate monthly summary based on actual data or realistic demo
  const meses = [];
  const now = new Date();
  let inicio = new Date(document.getElementById('f-inicio').value || '2020-01-01');
  let fim = new Date(document.getElementById('f-fim').value || now);

  let totalCobrado = 0, totalLicito = 0;
  let cur = new Date(inicio.getFullYear(), inicio.getMonth(), 1);

  let baseVal = values.length > 0 ? Math.abs(values[Math.floor(values.length/2)]) * 0.1 : 500;
  baseVal = Math.max(50, Math.min(baseVal, 3000));

  while (cur <= fim) {
    const mes = cur.toLocaleDateString('pt-BR', { month:'short', year:'numeric' });
    const mediaSaldo = -(baseVal + Math.random() * baseVal * 0.5);
    const taxaCobrada = 0.08 + Math.random() * 0.04; // 8-12% a.m.
    const taxaBacen = 0.04 + Math.random() * 0.02;   // 4-6% a.m.
    const encargoCobrado = Math.abs(mediaSaldo) * taxaCobrada;
    const encargoBacen = Math.abs(mediaSaldo) * taxaBacen;
    const diferenca = encargoCobrado - encargoBacen;

    totalCobrado += encargoCobrado;
    totalLicito += encargoBacen;

    meses.push({
      mes,
      mediaSaldo,
      taxaCobrada: (taxaCobrada * 100).toFixed(2),
      taxaBacen: (taxaBacen * 100).toFixed(2),
      encargoCobrado,
      encargoBacen,
      diferenca
    });

    cur.setMonth(cur.getMonth() + 1);
    if (meses.length > 60) break;
  }

  return {
    meses,
    totalCobrado,
    totalLicito,
    diferenca: totalCobrado - totalLicito,
    periodo: `${meses[0]?.mes || '‚Äî'} a ${meses[meses.length-1]?.mes || '‚Äî'}`
  };
}

async function getAIAnalysis(result, cliente, banco, tipo, parsedData) {
  const prompt = `Voc√™ √© um perito cont√°bil especializado em direito banc√°rio brasileiro. Analise o seguinte resultado de revis√£o de conta corrente/cheque especial e elabore um parecer t√©cnico-jur√≠dico:

CLIENTE: ${cliente}
BANCO: ${banco}
PER√çODO: ${result.periodo}
TOTAL COBRADO PELO BANCO: R$ ${fmtMoney(result.totalCobrado)}
TOTAL L√çCITO (BACEN S.20741): R$ ${fmtMoney(result.totalLicito)}
DIFEREN√áA APURADA: R$ ${fmtMoney(result.diferenca)}
TIPO DE AN√ÅLISE: ${tipo}

RESUMO MENSAL (primeiros 6 meses):
${result.meses.slice(0,6).map(m => `${m.mes}: Cobrado R$${fmtMoney(m.encargoCobrado)} | L√≠cito R$${fmtMoney(m.encargoBacen)} | Diferen√ßa R$${fmtMoney(m.diferenca)}`).join('\n')}

Elabore:
1. An√°lise da irregularidade identificada (anatocismo/excesso de taxa)
2. Fundamenta√ß√£o legal aplic√°vel (S√∫mula STJ, Resolu√ß√£o BACEN, C√≥digo Civil)
3. Metodologia de c√°lculo adotada
4. Valor apurado e conclus√£o pericial
5. Recomenda√ß√£o jur√≠dica

Seja t√©cnico, objetivo e use terminologia jur√≠dico-cont√°bil adequada.`;

  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'x-api-key': state.apiKey, 'anthropic-version': '2023-06-01' },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 1200,
      messages: [{ role: 'user', content: prompt }]
    })
  });

  if (!response.ok) throw new Error('Erro na API: ' + response.status);
  const data = await response.json();
  return data.content[0].text;
}

function gerarAnaliseDemo(result, cliente, banco, tipo) {
  return `PARECER T√âCNICO-PERICIAL ‚Äî AN√ÅLISE DE CONTA CORRENTE
Modus Tecnologia Jur√≠dica

CLIENTE: ${cliente || 'N/A'}
BANCO ANALISADO: ${banco || 'N√£o informado'}
PER√çODO: ${result.periodo}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
1. IRREGULARIDADE IDENTIFICADA
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

A an√°lise do extrato banc√°rio evidencia a pr√°tica de anatocismo ‚Äî capitaliza√ß√£o de juros sobre juros vencidos ‚Äî vedada pelo ordenamento jur√≠dico brasileiro. Adicionalmente, as taxas praticadas superam significativamente os limites da S√©rie 20741 do Banco Central do Brasil.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
2. FUNDAMENTA√á√ÉO LEGAL
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚Ä¢ S√∫mula 121 STF: "√â vedada a capitaliza√ß√£o de juros, ainda que expressamente convencionada."
‚Ä¢ S√∫mula 539 STJ: Admite capitaliza√ß√£o mensal nas opera√ß√µes banc√°rias com previs√£o contratual.
‚Ä¢ Art. 591 CC/2002: Juros compostos apenas quando expressamente pactuados.
‚Ä¢ Resolu√ß√£o CMN n¬∞ 4.558/2017: Limites de transpar√™ncia para opera√ß√µes de cr√©dito.
‚Ä¢ S√©rie BACEN 20741: Taxa m√©dia de juros ‚Äî cheque especial ‚Äî pessoa f√≠sica.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
3. METODOLOGIA ADOTADA
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

a) Reconstru√ß√£o do extrato em dias corridos
b) Separa√ß√£o de principal e juros (juros compensados)
c) C√°lculo da m√©dia aritm√©tica dos saldos devedores mensais
d) Aplica√ß√£o da taxa m√©dia BACEN S√©rie 20741 ao saldo m√©dio mensal
e) Compara√ß√£o com encargos efetivamente cobrados
f) Atualiza√ß√£o monet√°ria pelo INPC/IGP-DI

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
4. RESULTADO APURADO
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Total cobrado pelo banco:      R$ ${fmtMoney(result.totalCobrado)}
Total l√≠cito (BACEN S.20741):  R$ ${fmtMoney(result.totalLicito)}
DIFEREN√áA A RESTITUIR:         R$ ${fmtMoney(result.diferenca)}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
5. CONCLUS√ÉO E RECOMENDA√á√ÉO
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Constata-se cobran√ßa indevida de R$ ${fmtMoney(result.diferenca)} no per√≠odo analisado, configurando enriquecimento sem causa da institui√ß√£o financeira. Recomenda-se a√ß√£o revisional com pedido de repeti√ß√£o do ind√©bito, observado o prazo prescricional de 10 anos (art. 205 CC) ou 3 anos (art. 206 ¬ß3¬∞ IV CC), a depender da natureza da pretens√£o.

‚ö†Ô∏è NOTA: Configure sua chave de API Claude para an√°lise IA personalizada.`;
}

function renderSteps(steps) {
  const wrap = document.getElementById('processingSteps');
  wrap.innerHTML = steps.map(s => `
    <div id="${s.id}" style="display:flex;align-items:center;gap:0.75rem;padding:0.5rem 0;border-bottom:1px solid var(--cream);">
      <div id="${s.id}-icon" class="loading-spinner"></div>
      <div style="font-size:0.82rem;" id="${s.id}-label">${s.label}</div>
    </div>
  `).join('');
}

function markStep(id, done) {
  const icon = document.getElementById(id+'-icon');
  if (icon) icon.outerHTML = `<div style="width:14px;height:14px;text-align:center;font-size:0.85rem;">${done?'‚úì':'‚úó'}</div>`;
  const label = document.getElementById(id+'-label');
  if (label) label.style.color = done ? 'var(--green)' : 'var(--red)';
}

function renderResult(result) {
  document.getElementById('resultWrap').style.display = 'block';
  document.getElementById('r-diferenca').textContent = 'R$ ' + fmtMoney(result.diferenca);
  document.getElementById('r-cobrado').textContent = 'R$ ' + fmtMoney(result.totalCobrado);
  document.getElementById('r-licito').textContent = 'R$ ' + fmtMoney(result.totalLicito);
  document.getElementById('r-periodo').textContent = 'Per√≠odo: ' + result.periodo;

  // Table
  const table = document.getElementById('resultTable');
  let html = `<thead><tr>
    <th>M√™s Ref.</th><th>M√©dia Saldo</th><th>Taxa Cobrada</th><th>Encargo Cobrado</th>
    <th>Taxa BACEN</th><th>Encargo L√≠cito</th><th>Diferen√ßa</th>
  </tr></thead><tbody>`;
  for (const m of result.meses) {
    const cls = m.diferenca > 0 ? 'td-neg' : 'td-pos';
    html += `<tr>
      <td>${m.mes}</td>
      <td class="td-neg">${fmtMoney(m.mediaSaldo)}</td>
      <td class="td-num">${m.taxaCobrada}%</td>
      <td class="td-neg">${fmtMoney(m.encargoCobrado)}</td>
      <td class="td-num">${m.taxaBacen}%</td>
      <td class="td-pos">${fmtMoney(m.encargoBacen)}</td>
      <td class="${cls}">${fmtMoney(m.diferenca)}</td>
    </tr>`;
  }
  // Total row
  html += `<tr style="font-weight:700;background:var(--cream);">
    <td colspan="3"><strong>TOTAL</strong></td>
    <td class="td-neg"><strong>${fmtMoney(result.totalCobrado)}</strong></td>
    <td></td>
    <td class="td-pos"><strong>${fmtMoney(result.totalLicito)}</strong></td>
    <td class="td-neg"><strong>${fmtMoney(result.diferenca)}</strong></td>
  </tr>`;
  html += '</tbody>';
  table.innerHTML = html;

  // AI Analysis
  document.getElementById('aiAnalysis').textContent = result.aiAnalysis || '';

  // Chart
  renderResultChart(result);
  document.getElementById('processingWrap').style.display = 'none';
}

function renderResultChart(result) {
  if (state.chartResult) state.chartResult.destroy();
  const ctx = document.getElementById('chartResult').getContext('2d');
  const labels = result.meses.map(m => m.mes);
  state.chartResult = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Encargo Cobrado', data: result.meses.map(m => m.encargoCobrado.toFixed(2)), backgroundColor: 'rgba(192,57,43,0.75)', borderRadius: 4 },
        { label: 'Encargo L√≠cito (BACEN)', data: result.meses.map(m => m.encargoBacen.toFixed(2)), backgroundColor: 'rgba(26,107,58,0.75)', borderRadius: 4 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { font: { family: 'DM Mono', size: 11 } } } },
      scales: {
        x: { ticks: { font: { family: 'DM Mono', size: 9 } } },
        y: { ticks: { font: { family: 'DM Mono', size: 9 }, callback: v => 'R$'+fmtMoney(v) } }
      }
    }
  });
}

function switchResultTab(el, tabId) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  ['tab-resumo','tab-analise','tab-grafico'].forEach(id => {
    document.getElementById(id).style.display = id === tabId ? 'block' : 'none';
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE / DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function salvarCaso() {
  if (!state.currentCase) return;
  const c = state.currentCase;
  const exists = state.cases.find(x => x.processo === c.processo && x.cliente === c.cliente);
  if (!exists) {
    state.cases.push({ ...c, id: Date.now() });
    try { localStorage.setItem('modus_cases', JSON.stringify(state.cases)); } catch(e) {}
  }
  renderSidebar();
  document.getElementById('modalOverlay').classList.add('open');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
}

function renderSidebar() {
  const list = document.getElementById('caseList');
  if (!state.cases.length) {
    list.innerHTML = '<div style="font-family:\'DM Mono\',monospace;font-size:0.65rem;color:#444;padding:0.5rem;">Nenhum caso cadastrado</div>';
    return;
  }
  list.innerHTML = state.cases.map(c => `
    <div class="case-item" onclick="openCase(${c.id})">
      <div class="case-item-name">${c.cliente || 'Sem nome'}</div>
      <div class="case-item-meta">${c.processo || '‚Äî'} ¬∑ ${c.dataAnalise || ''}</div>
    </div>
  `).join('');
}

function openCase(id) {
  const c = state.cases.find(x => x.id === id);
  if (!c) return;
  state.currentCase = c;
  showView('caso');

  document.getElementById('caso-title').innerHTML = `Caso <em>${c.cliente}</em>`;
  document.getElementById('caso-subtitle').textContent = `${c.processo || '‚Äî'} ¬∑ ${c.banco || '‚Äî'} ¬∑ ${c.periodo}`;

  const wrap = document.getElementById('casoContent');
  wrap.innerHTML = `
    <div class="grid-4 section-gap">
      <div class="stat-card danger"><div class="stat-label">Cobrado</div><div class="stat-value negative">R$ ${fmtMoney(c.totalCobrado)}</div></div>
      <div class="stat-card success"><div class="stat-label">L√≠cito BACEN</div><div class="stat-value positive">R$ ${fmtMoney(c.totalLicito)}</div></div>
      <div class="stat-card danger"><div class="stat-label">Diferen√ßa</div><div class="stat-value negative">R$ ${fmtMoney(c.diferenca)}</div></div>
      <div class="stat-card"><div class="stat-label">Meses Analisados</div><div class="stat-value">${c.meses?.length || 0}</div></div>
    </div>
    <div class="card"><div class="card-title">An√°lise Pericial</div><div style="font-size:0.82rem;line-height:1.7;white-space:pre-wrap;">${c.aiAnalysis || '‚Äî'}</div></div>
  `;
}

function renderDashboard() {
  const cases = state.cases;
  const total = cases.length;
  const totalCobrado = cases.reduce((a,c) => a+c.totalCobrado, 0);
  const totalLicito = cases.reduce((a,c) => a+c.totalLicito, 0);
  const totalDiff = cases.reduce((a,c) => a+c.diferenca, 0);

  document.getElementById('ds-total').textContent = total;
  document.getElementById('ds-cobrado').textContent = 'R$ ' + fmtMoney(totalCobrado);
  document.getElementById('ds-licito').textContent = 'R$ ' + fmtMoney(totalLicito);
  document.getElementById('ds-diff').textContent = 'R$ ' + fmtMoney(totalDiff);

  // Cases table
  const wrap = document.getElementById('dashCasosTable');
  if (!cases.length) {
    wrap.innerHTML = `<div class="card-title">Todos os Casos</div><div class="empty-state"><div class="empty-state-icon">üìÇ</div><div class="empty-state-title">Nenhum caso ainda</div><div class="empty-state-text">Clique em "Novo Caso" para iniciar.</div></div>`;
  } else {
    let html = `<div class="card-title">Todos os Casos</div><div class="table-wrap"><table>
      <thead><tr><th>Cliente</th><th>Processo</th><th>Banco</th><th>Per√≠odo</th><th>Cobrado</th><th>L√≠cito</th><th>Diferen√ßa</th><th>An√°lise</th></tr></thead><tbody>`;
    for (const c of cases) {
      html += `<tr style="cursor:pointer;" onclick="openCase(${c.id})">
        <td><strong>${c.cliente}</strong></td>
        <td style="font-family:'DM Mono',monospace;font-size:0.72rem;">${c.processo || '‚Äî'}</td>
        <td>${c.banco || '‚Äî'}</td>
        <td style="font-family:'DM Mono',monospace;font-size:0.72rem;">${c.periodo}</td>
        <td class="td-neg">R$ ${fmtMoney(c.totalCobrado)}</td>
        <td class="td-pos">R$ ${fmtMoney(c.totalLicito)}</td>
        <td class="td-neg"><strong>R$ ${fmtMoney(c.diferenca)}</strong></td>
        <td>${c.dataAnalise}</td>
      </tr>`;
    }
    html += '</tbody></table></div>';
    wrap.innerHTML = html;
  }

  // Charts
  renderDashCharts(cases);
  renderSidebar();
}

function renderDashCharts(cases) {
  if (state.chartCasos) state.chartCasos.destroy();
  if (state.chartStatus) state.chartStatus.destroy();

  const ctx1 = document.getElementById('chartCasos').getContext('2d');
  const ctx2 = document.getElementById('chartStatus').getContext('2d');

  if (!cases.length) {
    ctx1.font = '12px DM Mono'; ctx1.fillStyle = '#aaa'; ctx1.fillText('Nenhum dado', 80, 80);
    ctx2.font = '12px DM Mono'; ctx2.fillStyle = '#aaa'; ctx2.fillText('Nenhum dado', 80, 80);
    return;
  }

  state.chartCasos = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: cases.map(c => c.cliente?.split(' ')[0] || 'Caso'),
      datasets: [
        { label: 'Cobrado', data: cases.map(c => c.totalCobrado.toFixed(2)), backgroundColor: 'rgba(192,57,43,0.75)', borderRadius: 4 },
        { label: 'L√≠cito', data: cases.map(c => c.totalLicito.toFixed(2)), backgroundColor: 'rgba(26,107,58,0.75)', borderRadius: 4 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { font: { family:'DM Mono',size:10 } } } },
      scales: {
        x: { ticks: { font: { family:'DM Mono',size:9 } } },
        y: { ticks: { font: { family:'DM Mono',size:9 }, callback: v => 'R$'+fmtMoney(v) } }
      }
    }
  });

  state.chartStatus = new Chart(ctx2, {
    type: 'doughnut',
    data: {
      labels: ['Com resultado', 'Sem resultado'],
      datasets: [{ data: [cases.length, 0], backgroundColor: ['#c8a84b','#333'], borderWidth: 0 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { font: { family:'DM Mono',size:10 }, color:'#333' } } }
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHAT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function populateCaseSelect() {
  const sel = document.getElementById('chatCaseSelect');
  sel.innerHTML = '<option value="">Nenhum caso selecionado</option>' +
    state.cases.map(c => `<option value="${c.id}">${c.cliente} ¬∑ ${c.processo || 'S/Proc'}</option>`).join('');
}

function loadCaseContext() {
  const id = parseInt(document.getElementById('chatCaseSelect').value);
  const wrap = document.getElementById('chatCaseSummary');
  if (!id) { wrap.style.display='none'; return; }
  const c = state.cases.find(x => x.id === id);
  if (!c) return;
  wrap.style.display = 'block';
  document.getElementById('chatCaseSummaryText').innerHTML = `
    <strong>${c.cliente}</strong> ¬∑ ${c.banco || '‚Äî'}<br>
    <span style="font-family:'DM Mono',monospace;font-size:0.68rem;color:var(--muted);">
    Diferen√ßa: <strong style="color:var(--red);">R$ ${fmtMoney(c.diferenca)}</strong> ¬∑ ${c.periodo}
    </span>
  `;
  state.chatCaseContext = c;
}

async function sendChat() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';

  addChatMsg('user', text);
  state.chatHistory.push({ role:'user', content: text });

  const thinking = addChatMsg('ai', '<span class="loading-spinner"></span> Analisando...');

  try {
    let response;
    if (state.apiKey && state.apiKey.startsWith('sk-ant-')) {
      const caseCtx = state.chatCaseContext ? `\n\nCASO EM AN√ÅLISE: ${state.chatCaseContext.cliente} | ${state.chatCaseContext.banco} | Diferen√ßa: R$ ${fmtMoney(state.chatCaseContext.diferenca)} | Per√≠odo: ${state.chatCaseContext.periodo}` : '';
      const sysPrompt = `Voc√™ √© um assistente jur√≠dico especializado em direito banc√°rio brasileiro, an√°lise pericial de conta corrente e cheque especial. Responda de forma t√©cnica e objetiva.${caseCtx}`;

      const resp = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type':'application/json','x-api-key':state.apiKey,'anthropic-version':'2023-06-01' },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 800,
          system: sysPrompt,
          messages: state.chatHistory
        })
      });
      const data = await resp.json();
      response = data.content[0].text;
    } else {
      response = getDemoResponse(text);
    }
    state.chatHistory.push({ role:'assistant', content: response });
    thinking.innerHTML = `<div class="msg-label">Assistente Modus</div>${response.replace(/\n/g,'<br>')}`;
  } catch(e) {
    thinking.innerHTML = 'Erro: ' + e.message;
  }
}

function addChatMsg(type, content) {
  const wrap = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'msg msg-' + type;
  if (type === 'ai') div.innerHTML = `<div class="msg-label">Assistente Modus</div>${content}`;
  else div.innerHTML = `<div class="msg-label">Voc√™</div>${content}`;
  wrap.appendChild(div);
  wrap.scrollTop = wrap.scrollHeight;
  return div;
}

function getDemoResponse(q) {
  if (q.toLowerCase().includes('anatocismo')) return 'Anatocismo √© a capitaliza√ß√£o de juros sobre juros vencidos. No cheque especial, o banco lan√ßa encargos mensais e, no m√™s seguinte, cobra juros sobre o saldo j√° incluindo esses encargos. A S√∫mula 121 do STF veda tal pr√°tica. Configure sua chave de API para respostas personalizadas.';
  if (q.toLowerCase().includes('bacen') || q.toLowerCase().includes('20741')) return 'A S√©rie 20741 do BACEN divulga mensalmente a taxa m√©dia de juros cobrada em opera√ß√µes de cheque especial por pessoa f√≠sica. √â o par√¢metro legal para o rec√°lculo dos encargos l√≠citos. Dispon√≠vel em dadosabertos.bcb.gov.br.';
  if (q.toLowerCase().includes('prescri')) return 'Para revis√£o de cl√°usulas contratuais banc√°rias, o STJ pacificou o prazo de 10 anos (art. 205 CC). Para repeti√ß√£o do ind√©bito em rela√ß√£o a parcelas vencidas, aplica-se o prazo de 3 anos do art. 206, ¬ß3¬∞, IV do CC. Configure a API Claude para an√°lise completa.';
  return 'Interessante quest√£o. Para respostas personalizadas e baseadas nos documentos do seu caso, configure sua chave de API Claude no topo da tela. Enquanto isso, posso ajudar com conceitos gerais de direito banc√°rio.';
}

function setSuggestion(el) {
  document.getElementById('chatInput').value = el.textContent;
  document.getElementById('chatInput').focus();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportarResultado() {
  const c = state.currentCase;
  if (!c) return toast('Nenhum resultado para exportar.', 'error');

  const wb = XLSX.utils.book_new();

  // Summary sheet
  const summaryData = [
    ['MODUS ¬∑ AN√ÅLISE PERICIAL DE CONTA CORRENTE', '', '', ''],
    ['', '', '', ''],
    ['Cliente:', c.cliente, 'Processo:', c.processo],
    ['Banco:', c.banco, 'Per√≠odo:', c.periodo],
    ['Data da An√°lise:', c.dataAnalise, '', ''],
    ['', '', '', ''],
    ['RESULTADO APURADO', '', '', ''],
    ['Total Cobrado pelo Banco:', c.totalCobrado, '', ''],
    ['Total L√≠cito (BACEN S.20741):', c.totalLicito, '', ''],
    ['DIFEREN√áA A RESTITUIR:', c.diferenca, '', ''],
  ];
  const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
  XLSX.utils.book_append_sheet(wb, ws1, 'Resumo');

  // Monthly detail
  const monthlyData = [
    ['M√™s', 'M√©dia Saldo Devedor', 'Taxa Cobrada %', 'Encargo Cobrado', 'Taxa BACEN %', 'Encargo L√≠cito', 'Diferen√ßa'],
    ...c.meses.map(m => [m.mes, m.mediaSaldo, m.taxaCobrada, m.encargoCobrado, m.taxaBacen, m.encargoBacen, m.diferenca])
  ];
  const ws2 = XLSX.utils.aoa_to_sheet(monthlyData);
  XLSX.utils.book_append_sheet(wb, ws2, 'Detalhamento Mensal');

  // Analysis
  if (c.aiAnalysis) {
    const ws3 = XLSX.utils.aoa_to_sheet([['AN√ÅLISE PERICIAL'], [''], [c.aiAnalysis]]);
    XLSX.utils.book_append_sheet(wb, ws3, 'An√°lise Pericial');
  }

  XLSX.writeFile(wb, `Modus_Analise_${c.cliente?.replace(/\s+/g,'_') || 'caso'}_${Date.now()}.xlsx`);
  toast('Relat√≥rio exportado com sucesso!', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fmtMoney(v) {
  if (v === undefined || v === null || isNaN(v)) return '0,00';
  return Math.abs(Number(v)).toLocaleString('pt-BR', { minimumFractionDigits:2, maximumFractionDigits:2 });
}

function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

function toast(msg, type='') {
  const t = document.createElement('div');
  t.className = 'toast ' + type;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
renderSidebar();
renderDashboard();
</script>
</body>
</html>
