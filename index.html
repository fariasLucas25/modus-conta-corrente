<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modus Â· AnÃ¡lise Pericial v2</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

<style>
:root {
  --ink: #0e0e10; --paper: #f5f2eb; --cream: #ede9df; --gold: #c8a84b;
  --gold-l: #e8d48a; --red: #c0392b; --green: #1a6b3a; --muted: #7a7670;
  --border: #d4cfc4; --card: #ffffff; --sh: 0 2px 16px rgba(14,14,16,.08);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Syne',sans-serif;background:var(--paper);color:var(--ink);min-height:100vh;overflow-x:hidden}

header{background:var(--ink);color:var(--paper);padding:0 2rem;height:58px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;border-bottom:2px solid var(--gold)}
.logo{font-family:'DM Serif Display',serif;font-size:1.3rem;letter-spacing:-.02em;display:flex;align-items:center;gap:.4rem}
.logo span{color:var(--gold)}
.logo-tag{font-family:'DM Mono',monospace;font-size:.6rem;color:#555;letter-spacing:.12em;text-transform:uppercase;margin-left:.6rem;padding-left:.6rem;border-left:1px solid #333}
.hdr-right{display:flex;align-items:center;gap:.75rem}
.api-wrap{display:flex;align-items:center;gap:.4rem}
.api-wrap label{font-family:'DM Mono',monospace;font-size:.6rem;color:#666;text-transform:uppercase;letter-spacing:.1em}
#apiKey{background:#1a1a1c;border:1px solid #333;color:var(--paper);font-family:'DM Mono',monospace;font-size:.72rem;padding:.3rem .65rem;border-radius:4px;width:210px;outline:none;transition:border-color .2s}
#apiKey:focus{border-color:var(--gold)}
.api-dot{width:7px;height:7px;border-radius:50%;background:#444;transition:background .3s}
.api-dot.on{background:#22c55e;box-shadow:0 0 6px #22c55e}
.version-badge{font-family:'DM Mono',monospace;font-size:.6rem;background:var(--gold);color:var(--ink);padding:.2rem .5rem;border-radius:3px;font-weight:600}

.layout{display:grid;grid-template-columns:248px 1fr;min-height:calc(100vh - 58px)}

aside{background:var(--ink);color:var(--paper);padding:1.25rem .85rem;display:flex;flex-direction:column;gap:.2rem;border-right:1px solid #1e1e20}
.s-sec{font-family:'DM Mono',monospace;font-size:.58rem;text-transform:uppercase;letter-spacing:.15em;color:#444;padding:.85rem .5rem .4rem}
.nav{display:flex;align-items:center;gap:.55rem;padding:.5rem .7rem;border-radius:5px;cursor:pointer;font-size:.8rem;font-weight:600;color:#888;transition:all .15s;border:1px solid transparent}
.nav:hover{background:#1a1a1c;color:var(--paper)}
.nav.on{background:#1a1a1c;color:var(--gold);border-color:#252525}
.nav-ic{font-size:.85rem;width:16px;text-align:center}
.case-list{flex:1;overflow-y:auto;margin-top:.25rem}
.case-item{padding:.55rem .7rem;border-radius:5px;cursor:pointer;font-size:.72rem;color:#777;border:1px solid transparent;transition:all .15s;margin-bottom:.15rem}
.case-item:hover{background:#1a1a1c;color:var(--paper)}
.case-item.on{background:#1a1a1c;border-color:var(--gold);color:var(--gold)}
.ci-name{font-weight:600;margin-bottom:.1rem}
.ci-meta{font-family:'DM Mono',monospace;font-size:.58rem;color:#444}
.case-item.on .ci-meta{color:#777}
.btn-new{margin-top:.4rem;width:100%;padding:.55rem;background:transparent;border:1px dashed #2a2a2a;color:#444;border-radius:5px;font-family:'Syne',sans-serif;font-size:.72rem;cursor:pointer;transition:all .15s}
.btn-new:hover{border-color:var(--gold);color:var(--gold)}

main{padding:1.75rem 2.25rem;overflow-y:auto;max-height:calc(100vh - 58px)}
.view{display:none}
.view.on{display:block}

.ph{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:1.75rem;padding-bottom:1.25rem;border-bottom:1px solid var(--border)}
.pt{font-family:'DM Serif Display',serif;font-size:1.85rem;font-weight:400;line-height:1.1;letter-spacing:-.03em}
.pt em{color:var(--gold);font-style:italic}
.ps{font-family:'DM Mono',monospace;font-size:.65rem;color:var(--muted);letter-spacing:.08em;margin-top:.35rem;text-transform:uppercase}

.card{background:var(--card);border:1px solid var(--border);border-radius:9px;padding:1.35rem;box-shadow:var(--sh)}
.ct{font-family:'DM Mono',monospace;font-size:.6rem;text-transform:uppercase;letter-spacing:.14em;color:var(--muted);margin-bottom:.85rem}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:1.1rem}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:.9rem}
.gap{margin-bottom:1.35rem}

.sc{background:var(--card);border:1px solid var(--border);border-radius:9px;padding:1.1rem 1.35rem;position:relative;overflow:hidden}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--gold)}
.sc.danger::before{background:var(--red)}
.sc.ok::before{background:var(--green)}
.sl{font-family:'DM Mono',monospace;font-size:.58rem;text-transform:uppercase;letter-spacing:.11em;color:var(--muted);margin-bottom:.4rem}
.sv{font-family:'DM Serif Display',serif;font-size:1.5rem;letter-spacing:-.03em;line-height:1}
.sv.neg{color:var(--red)}
.sv.pos{color:var(--green)}
.sd{font-family:'DM Mono',monospace;font-size:.6rem;color:var(--muted);margin-top:.3rem}

/* Upload */
.upload{border:2px dashed var(--border);border-radius:9px;padding:2.5rem 1.5rem;text-align:center;cursor:pointer;transition:all .2s;background:var(--cream);position:relative}
.upload:hover,.upload.drag{border-color:var(--gold);background:#fdf9ef}
.upload input{position:absolute;inset:0;opacity:0;cursor:pointer}
.upload-ic{font-size:2.2rem;margin-bottom:.75rem}
.upload-t{font-family:'DM Serif Display',serif;font-size:1rem;margin-bottom:.3rem}
.upload-h{font-family:'DM Mono',monospace;font-size:.65rem;color:var(--muted)}
.badges{display:flex;justify-content:center;gap:.4rem;margin-top:.6rem}
.bdg{font-family:'DM Mono',monospace;font-size:.58rem;padding:.18rem .45rem;border-radius:3px;letter-spacing:.07em;text-transform:uppercase}
.bdg-g{background:#fdf3d0;color:#8a6d1a;border:1px solid #e8d48a}
.bdg-b{background:#e8f0fe;color:#1a4a8a;border:1px solid #a8c0f0}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:.35rem;padding:.6rem 1.1rem;border-radius:5px;font-family:'Syne',sans-serif;font-size:.78rem;font-weight:700;cursor:pointer;border:none;transition:all .15s;text-transform:uppercase;letter-spacing:.05em}
.btn-dk{background:var(--ink);color:var(--paper)}
.btn-dk:hover{background:#1e1e20}
.btn-gd{background:var(--gold);color:var(--ink)}
.btn-gd:hover{background:var(--gold-l)}
.btn-ol{background:transparent;color:var(--ink);border:1.5px solid var(--border)}
.btn-ol:hover{border-color:var(--ink)}
.btn:disabled{opacity:.35;cursor:not-allowed}

/* Table */
.tw{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.78rem}
th{font-family:'DM Mono',monospace;font-size:.58rem;text-transform:uppercase;letter-spacing:.09em;color:var(--muted);padding:.55rem .9rem;border-bottom:2px solid var(--border);text-align:left;white-space:nowrap}
td{padding:.55rem .9rem;border-bottom:1px solid var(--cream);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:var(--cream)}
.tn{font-family:'DM Mono',monospace;text-align:right}
.tr-neg{color:var(--red);font-family:'DM Mono',monospace;text-align:right}
.tr-pos{color:var(--green);font-family:'DM Mono',monospace;text-align:right}

/* Form */
.fr{display:grid;grid-template-columns:1fr 1fr;gap:.9rem;margin-bottom:.9rem}
.fg{display:flex;flex-direction:column;gap:.35rem}
.fl{font-family:'DM Mono',monospace;font-size:.58rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted)}
.fi{padding:.55rem .8rem;border:1.5px solid var(--border);border-radius:5px;font-family:'Syne',sans-serif;font-size:.82rem;background:var(--paper);outline:none;transition:border-color .2s}
.fi:focus{border-color:var(--gold)}

/* Tabs */
.tabs{display:flex;border-bottom:2px solid var(--border);margin-bottom:1.35rem}
.tab{padding:.55rem 1.1rem;font-family:'DM Mono',monospace;font-size:.63rem;text-transform:uppercase;letter-spacing:.09em;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s;white-space:nowrap}
.tab:hover{color:var(--ink)}
.tab.on{color:var(--ink);border-bottom-color:var(--gold);font-weight:600}

/* Chat */
.chat-wrap{border:1px solid var(--border);border-radius:9px;overflow:hidden;display:flex;flex-direction:column;height:460px;background:var(--card)}
.chat-hdr{background:var(--ink);color:var(--paper);padding:.65rem 1.1rem;display:flex;align-items:center;gap:.4rem}
.chat-hdr-t{font-family:'DM Mono',monospace;font-size:.65rem;letter-spacing:.1em;text-transform:uppercase}
.chat-dot{width:6px;height:6px;border-radius:50%;background:var(--gold)}
.chat-msgs{flex:1;overflow-y:auto;padding:1.1rem;display:flex;flex-direction:column;gap:.65rem}
.msg{max-width:86%;padding:.7rem .9rem;border-radius:7px;font-size:.8rem;line-height:1.5}
.msg-ai{background:var(--cream);border:1px solid var(--border);align-self:flex-start;border-bottom-left-radius:2px}
.msg-u{background:var(--ink);color:var(--paper);align-self:flex-end;border-bottom-right-radius:2px}
.msg-lbl{font-family:'DM Mono',monospace;font-size:.55rem;text-transform:uppercase;letter-spacing:.09em;color:var(--muted);margin-bottom:.25rem}
.msg-u .msg-lbl{color:#888}
.chat-in-wrap{padding:.85rem;border-top:1px solid var(--border);display:flex;gap:.4rem}
#chatIn{flex:1;padding:.6rem .9rem;border:1.5px solid var(--border);border-radius:5px;font-family:'Syne',sans-serif;font-size:.8rem;outline:none;background:var(--paper);transition:border-color .2s}
#chatIn:focus{border-color:var(--gold)}

/* Progress */
.spin{display:inline-block;width:13px;height:13px;border:2px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:sp .7s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}

/* Result highlight */
.rh{background:linear-gradient(135deg,#fdf9ef,#fff);border:1.5px solid var(--gold);border-radius:9px;padding:1.35rem 1.75rem;margin-bottom:1.35rem;display:flex;align-items:center;justify-content:space-between;gap:1.5rem}
.rh-lbl{font-family:'DM Mono',monospace;font-size:.6rem;text-transform:uppercase;letter-spacing:.11em;color:var(--muted);margin-bottom:.4rem}
.rh-val{font-family:'DM Serif Display',serif;font-size:2.5rem;color:var(--red);letter-spacing:-.04em;line-height:1}

/* Animations */
.fade-up{animation:fu .35s ease}
@keyframes fu{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* Toast */
.toast{position:fixed;bottom:1.25rem;right:1.25rem;background:var(--ink);color:var(--paper);padding:.65rem 1.1rem;border-radius:7px;font-size:.8rem;border-left:3px solid var(--gold);animation:si .25s ease;z-index:999;max-width:300px}
.toast.err{border-left-color:var(--red)}
.toast.ok{border-left-color:var(--green)}
@keyframes si{from{transform:translateX(110%);opacity:0}to{transform:translateX(0);opacity:1}}

/* Modal */
.overlay{position:fixed;inset:0;background:rgba(14,14,16,.6);display:none;align-items:center;justify-content:center;z-index:200}
.overlay.on{display:flex}
.modal{background:var(--card);border-radius:10px;padding:1.75rem;max-width:500px;width:90%;border:1px solid var(--border);box-shadow:0 8px 40px rgba(14,14,16,.14);animation:fu .25s ease}
.modal-t{font-family:'DM Serif Display',serif;font-size:1.3rem;margin-bottom:1rem}
.modal-act{display:flex;justify-content:flex-end;gap:.65rem;margin-top:1.35rem}

/* Steps */
.step{display:flex;align-items:center;gap:.65rem;padding:.45rem 0;border-bottom:1px solid var(--cream)}
.step-ic{width:14px;height:14px;display:flex;align-items:center;justify-content:center;font-size:.8rem;flex-shrink:0}
.step-txt{font-size:.8rem}
.step.done .step-txt{color:var(--green)}
.step.err .step-txt{color:var(--red)}

/* Sugg */
.sugg{padding:.55rem .8rem;background:var(--cream);border:1px solid var(--border);border-radius:5px;font-size:.75rem;cursor:pointer;transition:all .15s;line-height:1.4;margin-bottom:.4rem}
.sugg:hover{border-color:var(--gold);background:#fdf9ef}

/* Chart */
.ch-wrap{position:relative;height:240px}

/* Confiabilidade badge */
.conf-badge{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .65rem;border-radius:20px;font-family:'DM Mono',monospace;font-size:.58rem;font-weight:600;text-transform:uppercase;letter-spacing:.08em}
.conf-real{background:#e8f5ee;color:#1a6b3a;border:1px solid #a8d4b8}
.conf-api{background:#e8f0fe;color:#1a4a8a;border:1px solid #a8c0f0}

::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

/* Info box */
.info-box{background:#fdf9ef;border:1px solid var(--gold-l);border-radius:7px;padding:.9rem 1.1rem;font-size:.8rem;line-height:1.6;margin-bottom:1rem}
.info-box strong{color:var(--ink)}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">
    <span>Modus</span>
    <div class="logo-tag">Conta Corrente Â· AnÃ¡lise Pericial</div>
  </div>
  <div class="hdr-right">
    <span class="version-badge">v2 Â· CÃ¡lculos Reais</span>
    <div class="api-wrap">
      <label>API Claude</label>
      <input type="password" id="apiKey" placeholder="sk-ant-..." oninput="onKey(this.value)">
      <div class="api-dot" id="dot"></div>
    </div>
  </div>
</header>

<div class="layout">

<!-- SIDEBAR -->
<aside>
  <div class="s-sec">NavegaÃ§Ã£o</div>
  <div class="nav on" id="n-dash" onclick="go('dash')"><span class="nav-ic">â–¦</span> Dashboard</div>
  <div class="nav" id="n-novo" onclick="go('novo')"><span class="nav-ic">ï¼‹</span> Novo Caso</div>
  <div class="nav" id="n-chat" onclick="go('chat')"><span class="nav-ic">â—‰</span> Assistente I.A.</div>
  <div class="nav" id="n-ajuda" onclick="go('ajuda')"><span class="nav-ic">?</span> Como Funciona</div>

  <div class="s-sec">Casos Salvos</div>
  <div class="case-list" id="cList"><div style="font-family:'DM Mono',monospace;font-size:.62rem;color:#333;padding:.4rem .5rem">Nenhum caso salvo</div></div>
  <button class="btn-new" onclick="go('novo')">+ Novo Caso</button>
</aside>

<!-- MAIN -->
<main>

<!-- â•â• DASHBOARD â•â• -->
<div class="view on" id="v-dash">
  <div class="ph">
    <div><div class="pt">Painel <em>Geral</em></div><div class="ps">Todos os casos Â· VisÃ£o consolidada</div></div>
    <button class="btn btn-gd" onclick="go('novo')">+ Novo Caso</button>
  </div>
  <div class="g4 gap" id="d-stats">
    <div class="sc"><div class="sl">Total de Casos</div><div class="sv" id="d-total">0</div></div>
    <div class="sc danger"><div class="sl">Cobrado Total</div><div class="sv neg" id="d-cob">R$ 0</div></div>
    <div class="sc ok"><div class="sl">LÃ­cito Total</div><div class="sv pos" id="d-lic">R$ 0</div></div>
    <div class="sc danger"><div class="sl">A Restituir</div><div class="sv neg" id="d-dif">R$ 0</div></div>
  </div>
  <div class="g2 gap">
    <div class="card"><div class="ct">Cobrado vs. LÃ­cito por Caso</div><div class="ch-wrap"><canvas id="ch1"></canvas></div></div>
    <div class="card"><div class="ct">DistribuiÃ§Ã£o dos Casos</div><div class="ch-wrap"><canvas id="ch2"></canvas></div></div>
  </div>
  <div class="card" id="d-table"></div>
</div>

<!-- â•â• NOVO CASO â•â• -->
<div class="view" id="v-novo">
  <div class="ph">
    <div><div class="pt">Novo <em>Caso</em></div><div class="ps">Importe o extrato e configure os parÃ¢metros</div></div>
  </div>

  <div class="card gap">
    <div class="ct">1 Â· Dados do Processo</div>
    <div class="fr">
      <div class="fg"><label class="fl">NÃºmero do Processo</label><input class="fi" id="f-proc" placeholder="0000000-00.0000.0.00.0000"></div>
      <div class="fg"><label class="fl">Cliente / Parte</label><input class="fi" id="f-cli" placeholder="Nome completo"></div>
    </div>
    <div class="fr">
      <div class="fg"><label class="fl">Banco</label>
        <select class="fi" id="f-banco">
          <option value="">Selecione</option>
          <option>Banco do Brasil</option><option>Bradesco</option><option>Caixa EconÃ´mica Federal</option>
          <option>ItaÃº</option><option>Nubank</option><option>Santander</option><option>Outro</option>
        </select>
      </div>
      <div class="fg"><label class="fl">Modalidade de CÃ¡lculo</label>
        <select class="fi" id="f-modo">
          <option value="corridos">Dias Corridos</option>
          <option value="uteis">Dias Ãšteis</option>
        </select>
      </div>
    </div>
  </div>

  <div class="card gap">
    <div class="ct">2 Â· Importar Extrato (PDF ou Excel)</div>
    <div class="info-box">
      <strong>Como o sistema lÃª o PDF:</strong> O extrato Ã© processado linha a linha buscando padrÃµes de data e valor. Para melhores resultados, use extratos exportados diretamente do internet banking (nÃ£o digitalizados/escaneados). Se o PDF for escaneado, o Claude AI farÃ¡ a extraÃ§Ã£o via anÃ¡lise de imagem.
    </div>
    <div class="upload" id="upZone">
      <input type="file" id="fileIn" accept=".pdf,.xlsx,.xls,.csv" onchange="handleFile(this.files[0])">
      <div class="upload-ic">ğŸ“„</div>
      <div class="upload-t">Arraste o arquivo ou clique para selecionar</div>
      <div class="upload-h">Extrato do internet banking Â· Cheque especial / Conta corrente</div>
      <div class="badges">
        <span class="bdg bdg-b">PDF</span><span class="bdg bdg-g">XLSX</span><span class="bdg bdg-g">CSV</span>
      </div>
    </div>
    <div id="fStatus" style="display:none;margin-top:.9rem">
      <div style="display:flex;align-items:center;gap:.65rem;padding:.7rem .9rem;background:var(--cream);border-radius:6px;border:1px solid var(--border)">
        <span style="font-size:1.1rem">ğŸ“‹</span>
        <div><div style="font-weight:600;font-size:.82rem" id="fName"></div><div style="font-family:'DM Mono',monospace;font-size:.62rem;color:var(--muted)" id="fInfo"></div></div>
        <div style="margin-left:auto;font-family:'DM Mono',monospace;font-size:.6rem;color:var(--green)" id="fConf"></div>
      </div>
    </div>
    <div id="prevWrap" style="display:none;margin-top:.9rem">
      <div class="ct" style="margin-bottom:.65rem">Dados identificados no extrato</div>
      <div class="tw"><table id="prevTable"></table></div>
    </div>
  </div>

  <div style="display:flex;gap:.75rem;justify-content:flex-end">
    <button class="btn btn-ol" onclick="go('dash')">Cancelar</button>
    <button class="btn btn-gd" id="btnAn" onclick="analisar()" disabled>âš¡ Calcular e Analisar</button>
  </div>

  <div id="procWrap" style="display:none;margin-top:1.25rem" class="card">
    <div class="ct">Processamento</div>
    <div id="procSteps"></div>
    <div style="margin-top:.75rem;font-family:'DM Mono',monospace;font-size:.65rem;color:var(--muted)" id="procMsg"></div>
  </div>

  <div id="resWrap" style="display:none;margin-top:1.35rem" class="fade-up">
    <div class="rh">
      <div>
        <div class="rh-lbl">DiferenÃ§a Apurada Â· Valor a Restituir</div>
        <div class="rh-val" id="r-dif">â€”</div>
        <div style="font-family:'DM Mono',monospace;font-size:.65rem;color:var(--muted);margin-top:.4rem" id="r-per"></div>
        <div style="margin-top:.5rem" id="r-conf"></div>
      </div>
      <div style="display:flex;gap:1.75rem">
        <div><div class="rh-lbl">Cobrado Banco</div><div style="font-family:'DM Serif Display',serif;font-size:1.4rem;color:var(--red)" id="r-cob">â€”</div></div>
        <div><div class="rh-lbl">LÃ­cito BACEN S.20741</div><div style="font-family:'DM Serif Display',serif;font-size:1.4rem;color:var(--green)" id="r-lic">â€”</div></div>
      </div>
    </div>
    <div class="tabs">
      <div class="tab on" onclick="rTab(this,'rt-res')">Resumo Mensal</div>
      <div class="tab" onclick="rTab(this,'rt-dia')">Detalhamento DiÃ¡rio</div>
      <div class="tab" onclick="rTab(this,'rt-ai')">Parecer I.A.</div>
      <div class="tab" onclick="rTab(this,'rt-gr')">GrÃ¡fico</div>
    </div>
    <div id="rt-res" class="card"><div class="tw"><table id="tMes"></table></div></div>
    <div id="rt-dia" class="card" style="display:none"><div class="tw"><table id="tDia"></table></div></div>
    <div id="rt-ai" class="card" style="display:none"><div id="aiTxt" style="font-size:.82rem;line-height:1.75;white-space:pre-wrap"></div></div>
    <div id="rt-gr" class="card" style="display:none"><div class="ch-wrap"><canvas id="chRes"></canvas></div></div>
    <div style="display:flex;gap:.65rem;margin-top:.9rem">
      <button class="btn btn-dk" onclick="exportar()">â¬‡ Exportar Excel</button>
      <button class="btn btn-ol" onclick="salvar()">ğŸ’¾ Salvar Caso</button>
    </div>
  </div>
</div>

<!-- â•â• CHAT â•â• -->
<div class="view" id="v-chat">
  <div class="ph"><div><div class="pt">Assistente <em>I.A.</em></div><div class="ps">Consulte sobre qualquer aspecto jurÃ­dico-contÃ¡bil</div></div></div>
  <div class="g2">
    <div class="chat-wrap">
      <div class="chat-hdr"><div class="chat-dot"></div><div class="chat-hdr-t">Assistente Modus Â· Direito BancÃ¡rio</div></div>
      <div class="chat-msgs" id="chatMsgs">
        <div class="msg msg-ai"><div class="msg-lbl">Assistente</div>OlÃ¡! Sou especializado em anÃ¡lise de conta corrente e cheque especial. Pergunte sobre:<br><br>â€¢ Anatocismo e capitalizaÃ§Ã£o de juros<br>â€¢ Taxas BACEN SÃ©rie 20741<br>â€¢ Metodologia de cÃ¡lculo pericial<br>â€¢ FundamentaÃ§Ã£o jurÃ­dica<br>â€¢ InterpretaÃ§Ã£o de resultados</div>
      </div>
      <div class="chat-in-wrap">
        <input id="chatIn" placeholder="Pergunta sobre o caso ou conceito jurÃ­dico..." onkeydown="if(event.key==='Enter')enviar()">
        <button class="btn btn-dk" onclick="enviar()">Enviar</button>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;gap:.9rem">
      <div class="card">
        <div class="ct">Contexto do Caso</div>
        <select class="fi" id="chatCase" onchange="loadCtx()" style="width:100%">
          <option value="">Sem caso selecionado</option>
        </select>
        <div id="ctxSum" style="display:none;margin-top:.75rem;font-size:.78rem;line-height:1.6" id="ctxTxt"></div>
      </div>
      <div class="card">
        <div class="ct">SugestÃµes de Perguntas</div>
        <div class="sugg" onclick="setSugg(this)">Qual o fundamento jurÃ­dico para cobrar anatocismo em cheque especial?</div>
        <div class="sugg" onclick="setSugg(this)">Como a SÃ©rie 20741 do BACEN Ã© usada para limitar os juros?</div>
        <div class="sugg" onclick="setSugg(this)">Explique as 6 hipÃ³teses dos juros compensados na metodologia pericial.</div>
        <div class="sugg" onclick="setSugg(this)">Qual a diferenÃ§a entre dias Ãºteis e dias corridos no cÃ¡lculo da mÃ©dia?</div>
        <div class="sugg" onclick="setSugg(this)">Qual prazo prescricional para aÃ§Ã£o de revisÃ£o de cheque especial?</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â• AJUDA â•â• -->
<div class="view" id="v-ajuda">
  <div class="ph"><div><div class="pt">Como <em>Funciona</em></div><div class="ps">Metodologia e confiabilidade do sistema</div></div></div>
  <div class="g2 gap">
    <div class="card">
      <div class="ct">Confiabilidade dos CÃ¡lculos</div>
      <div style="font-size:.82rem;line-height:1.7">
        <p style="margin-bottom:.75rem"><span class="conf-badge conf-real">âœ“ CÃ¡lculo Real</span> A engine de cÃ¡lculo implementa <strong>fielmente</strong> a metodologia do <em>Procedimentos.docm</em>, incluindo:</p>
        <ul style="list-style:none;display:flex;flex-direction:column;gap:.4rem">
          <li>ğŸ“ SeparaÃ§Ã£o de principal e juros (juros compensados)</li>
          <li>ğŸ“ As 6 hipÃ³teses de quitaÃ§Ã£o de encargos</li>
          <li>ğŸ“ MÃ©dia aritmÃ©tica dos saldos devedores (dias corridos ou Ãºteis)</li>
          <li>ğŸ“ IdentificaÃ§Ã£o de dias Ãºteis com feriados nacionais 2010â€“2024</li>
          <li>ğŸ“ Taxas BACEN SÃ©rie 20741 reais (2010â€“2024) embutidas no sistema</li>
          <li>ğŸ“ ComparaÃ§Ã£o com a menor taxa (cobrada x BACEN)</li>
        </ul>
        <p style="margin-top:.75rem"><span class="conf-badge conf-api">âœ¦ IA</span> O parecer jurÃ­dico Ã© gerado pela API Claude com base nos resultados calculados.</p>
      </div>
    </div>
    <div class="card">
      <div class="ct">LimitaÃ§Ãµes Conhecidas</div>
      <div style="font-size:.82rem;line-height:1.7">
        <p style="margin-bottom:.5rem"><strong>PDF digitalizado (escaneado):</strong> Requer chave Claude configurada para extraÃ§Ã£o por OCR via IA. PDFs nativos (exportados do internet banking) funcionam sem API.</p>
        <p style="margin-bottom:.5rem"><strong>INPC/IGP-DI:</strong> A atualizaÃ§Ã£o monetÃ¡ria das diferenÃ§as ainda nÃ£o estÃ¡ implementada (em desenvolvimento para v3).</p>
        <p style="margin-bottom:.5rem"><strong>Taxas BACEN:</strong> A base embutida vai atÃ© junho/2024. Para casos mais recentes, o sistema busca automaticamente na API do Banco Central (requer internet).</p>
        <p><strong>Anatocismo com Anatocismo:</strong> O cÃ¡lculo "Com Anatocismo" (planilha Bacen) estÃ¡ em desenvolvimento. A v2 implementa o mÃ©todo "Sem Anatocismo" completo.</p>
      </div>
    </div>
  </div>
  <div class="card gap">
    <div class="ct">Fluxo do CÃ¡lculo (Metodologia Pericial)</div>
    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:.75rem;text-align:center">
      <div style="padding:.9rem;background:var(--cream);border-radius:7px;border:1px solid var(--border)"><div style="font-size:1.3rem;margin-bottom:.4rem">ğŸ“„</div><div style="font-size:.72rem;font-weight:700">1. Extrato</div><div style="font-family:'DM Mono',monospace;font-size:.6rem;color:var(--muted);margin-top:.2rem">Saldos diÃ¡rios + encargos cobrados</div></div>
      <div style="padding:.9rem;background:var(--cream);border-radius:7px;border:1px solid var(--border)"><div style="font-size:1.3rem;margin-bottom:.4rem">ğŸ“…</div><div style="font-size:.72rem;font-weight:700">2. SÃ©rie DiÃ¡ria</div><div style="font-family:'DM Mono',monospace;font-size:.6rem;color:var(--muted);margin-top:.2rem">Dias Ãºteis, feriados, mÃªs de ref.</div></div>
      <div style="padding:.9rem;background:var(--cream);border-radius:7px;border:1px solid var(--border)"><div style="font-size:1.3rem;margin-bottom:.4rem">âš–ï¸</div><div style="font-size:.72rem;font-weight:700">3. Juros Comp.</div><div style="font-family:'DM Mono',monospace;font-size:.6rem;color:var(--muted);margin-top:.2rem">6 hipÃ³teses de separaÃ§Ã£o principal/juros</div></div>
      <div style="padding:.9rem;background:var(--cream);border-radius:7px;border:1px solid var(--border)"><div style="font-size:1.3rem;margin-bottom:.4rem">ğŸ¦</div><div style="font-size:.72rem;font-weight:700">4. BACEN S.20741</div><div style="font-family:'DM Mono',monospace;font-size:.6rem;color:var(--muted);margin-top:.2rem">Menor taxa: cobrada vs. BACEN</div></div>
      <div style="padding:.9rem;background:var(--cream);border-radius:7px;border:1px solid var(--border)"><div style="font-size:1.3rem;margin-bottom:.4rem">ğŸ“Š</div><div style="font-size:.72rem;font-weight:700">5. DiferenÃ§a</div><div style="font-family:'DM Mono',monospace;font-size:.6rem;color:var(--muted);margin-top:.2rem">Valor a restituir por mÃªs e total</div></div>
    </div>
  </div>
  <div class="card">
    <div class="ct">Formatos de Extrato Suportados</div>
    <table>
      <thead><tr><th>Banco</th><th>Formato</th><th>Compatibilidade</th><th>ObservaÃ§Ã£o</th></tr></thead>
      <tbody>
        <tr><td>Qualquer banco</td><td class="tn">PDF nativo</td><td class="tr-pos">âœ“ Plena</td><td>Exportado do internet banking</td></tr>
        <tr><td>Qualquer banco</td><td class="tn">XLSX / XLS</td><td class="tr-pos">âœ“ Plena</td><td>Excel do internet banking</td></tr>
        <tr><td>Qualquer banco</td><td class="tn">CSV</td><td class="tr-pos">âœ“ Plena</td><td>ExportaÃ§Ã£o CSV</td></tr>
        <tr><td>Qualquer banco</td><td class="tn">PDF escaneado</td><td style="color:var(--gold);font-family:'DM Mono',monospace;text-align:right">~ API</td><td>Requer chave Claude configurada</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- â•â• CASO â•â• -->
<div class="view" id="v-caso">
  <div class="ph">
    <div><div class="pt" id="caso-t">Caso</div><div class="ps" id="caso-s"></div></div>
    <div style="display:flex;gap:.65rem">
      <button class="btn btn-ol" onclick="go('chat')">ğŸ¤– Consultar IA</button>
      <button class="btn btn-dk" onclick="exportar()">â¬‡ Exportar</button>
    </div>
  </div>
  <div id="casoC"></div>
</div>

</main>
</div>

<!-- MODAL -->
<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modal-t">Caso salvo!</div>
    <p style="font-size:.82rem;line-height:1.6;color:var(--muted)">O caso foi adicionado ao painel e estarÃ¡ disponÃ­vel na barra lateral.</p>
    <div class="modal-act">
      <button class="btn btn-ol" onclick="closeM()">Fechar</button>
      <button class="btn btn-gd" onclick="closeM();go('dash')">Ver Painel</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DADOS REAIS EMBUTIDOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Taxas BACEN SÃ©rie 20741 (% mensal) â€” extraÃ­das da planilha real
const BACEN = {"2010-12":0.086531,"2011-01":0.087151,"2011-02":0.0854,"2011-03":0.077654,"2011-04":0.078702,"2011-05":0.079255,"2011-06":0.079604,"2011-07":0.079894,"2011-08":0.079797,"2011-09":0.079815,"2011-10":0.079947,"2011-11":0.08023,"2011-12":0.079654,"2012-01":0.079596,"2012-02":0.079568,"2012-03":0.079708,"2012-04":0.077221,"2012-05":0.075657,"2012-06":0.075042,"2012-07":0.070388,"2012-08":0.069639,"2012-09":0.069612,"2012-10":0.069245,"2012-11":0.069129,"2012-12":0.068681,"2013-01":0.068877,"2013-02":0.068949,"2013-03":0.068753,"2013-04":0.068565,"2013-05":0.068367,"2013-06":0.068625,"2013-07":0.068701,"2013-08":0.068973,"2013-09":0.070115,"2013-10":0.070447,"2013-11":0.070883,"2013-12":0.071556,"2014-01":0.073759,"2014-02":0.074582,"2014-03":0.075432,"2014-04":0.076216,"2014-05":0.07851,"2014-06":0.079521,"2014-07":0.080222,"2014-08":0.080507,"2014-09":0.082813,"2014-10":0.083976,"2014-11":0.085048,"2014-12":0.087827,"2015-01":0.090024,"2015-02":0.091507,"2015-03":0.093185,"2015-04":0.094802,"2015-05":0.096582,"2015-06":0.09878,"2015-07":0.099999,"2015-08":0.101472,"2015-09":0.104307,"2015-10":0.107769,"2015-11":0.109455,"2015-12":0.110326,"2016-01":0.111601,"2016-02":0.111581,"2016-03":0.11342,"2016-04":0.114937,"2016-05":0.115254,"2016-06":0.115984,"2016-07":0.116892,"2016-08":0.118034,"2016-09":0.118019,"2016-10":0.118934,"2016-11":0.118801,"2016-12":0.118302,"2017-01":0.118149,"2017-02":0.117473,"2017-03":0.118295,"2017-04":0.118246,"2017-05":0.117586,"2017-06":0.116894,"2017-07":0.116565,"2017-08":0.115782,"2017-09":0.116778,"2017-10":0.117043,"2017-11":0.116793,"2017-12":0.115994,"2018-01":0.116707,"2018-02":0.116327,"2018-03":0.116719,"2018-04":0.116215,"2018-05":0.114257,"2018-06":0.112763,"2018-07":0.112206,"2018-08":0.112014,"2018-09":0.111471,"2018-10":0.11197,"2018-11":0.112979,"2018-12":0.11312,"2019-01":0.1145,"2019-02":0.114074,"2019-03":0.115629,"2019-04":0.116479,"2019-05":0.115857,"2019-06":0.115822,"2019-07":0.115083,"2019-08":0.111463,"2019-09":0.108885,"2019-10":0.112755,"2019-11":0.11367,"2019-12":0.109394,"2020-01":0.075989,"2020-02":0.072107,"2020-03":0.072111,"2020-04":0.067733,"2020-05":0.06637,"2020-06":0.064888,"2020-07":0.064507,"2020-08":0.064691,"2020-09":0.06547,"2020-10":0.064737,"2020-11":0.065237,"2020-12":0.066111,"2021-01":0.068029,"2021-02":0.070119,"2021-03":0.068829,"2021-04":0.069651,"2021-05":0.069125,"2021-06":0.070155,"2021-07":0.069524,"2021-08":0.069953,"2021-09":0.071727,"2021-10":0.071169,"2021-11":0.071746,"2021-12":0.071071,"2022-01":0.07017,"2022-02":0.072837,"2022-03":0.071032,"2022-04":0.072914,"2022-05":0.071036,"2022-06":0.071548,"2022-07":0.070867,"2022-08":0.071267,"2022-09":0.07353,"2022-10":0.073179,"2022-11":0.07332,"2022-12":0.072694,"2023-01":0.072301,"2023-02":0.073668,"2023-03":0.07201,"2023-04":0.073224,"2023-05":0.072165,"2023-06":0.07363,"2023-07":0.072664,"2023-08":0.072606,"2023-09":0.073393,"2023-10":0.072482,"2023-11":0.072837,"2023-12":0.071138,"2024-01":0.070214,"2024-02":0.072683,"2024-03":0.071142,"2024-04":0.072123,"2024-05":0.072602,"2024-06":0.073782};

// Feriados nacionais 2010â€“2024 (extraÃ­dos da planilha real)
const FERIADOS = new Set(["2010-01-01","2010-02-16","2010-04-02","2010-04-21","2010-05-01","2010-06-03","2010-09-07","2010-10-12","2010-11-02","2010-11-15","2010-12-25","2011-01-01","2011-03-08","2011-04-21","2011-04-22","2011-04-24","2011-05-01","2011-06-23","2011-09-07","2011-10-12","2011-11-02","2011-11-15","2011-12-25","2012-01-01","2012-02-21","2012-04-06","2012-04-08","2012-04-21","2012-05-01","2012-06-07","2012-09-07","2012-10-12","2012-11-02","2012-11-15","2012-12-25","2013-01-01","2013-02-12","2013-03-29","2013-03-31","2013-04-21","2013-05-01","2013-05-30","2013-09-07","2013-10-12","2013-11-02","2013-11-15","2013-12-25","2014-01-01","2014-03-04","2014-04-18","2014-04-20","2014-04-21","2014-05-01","2014-06-19","2014-09-07","2014-10-12","2014-11-02","2014-11-15","2014-12-25","2015-01-01","2015-02-17","2015-04-03","2015-04-05","2015-04-21","2015-05-01","2015-06-04","2015-09-07","2015-10-12","2015-11-02","2015-11-15","2015-12-25","2016-01-01","2016-02-09","2016-03-25","2016-03-27","2016-04-21","2016-05-01","2016-05-26","2016-09-07","2016-10-12","2016-11-02","2016-11-15","2016-12-25","2017-01-01","2017-02-28","2017-04-14","2017-04-16","2017-04-21","2017-05-01","2017-06-15","2017-09-07","2017-10-12","2017-11-02","2017-11-15","2017-12-25","2018-01-01","2018-02-13","2018-03-30","2018-04-01","2018-04-21","2018-05-01","2018-05-31","2018-09-07","2018-10-12","2018-11-02","2018-11-15","2018-12-25","2019-01-01","2019-03-05","2019-04-19","2019-04-21","2019-05-01","2019-06-20","2019-09-07","2019-10-12","2019-11-02","2019-11-15","2019-12-25","2020-01-01","2020-02-25","2020-04-10","2020-04-12","2020-04-21","2020-05-01","2020-06-11","2020-09-07","2020-10-12","2020-11-02","2020-11-15","2020-12-25"]);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITÃRIOS DE DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dtKey(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function mesKey(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
}
function eomDate(d) {
  return new Date(d.getFullYear(), d.getMonth()+1, 0);
}
function isDiaUtil(d) {
  const dow = d.getDay(); // 0=dom, 6=sab
  if (dow === 0 || dow === 6) return false;
  if (FERIADOS.has(dtKey(d))) return false;
  return true;
}
function nextDay(d) {
  const n = new Date(d); n.setDate(n.getDate()+1); return n;
}
function parseDate(s) {
  if (!s) return null;
  if (s instanceof Date) return isNaN(s.getTime()) ? null : s;
  s = String(s).trim();
  // dd/mm/yyyy or dd/mm/yy
  let m = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
  if (m) {
    let y = parseInt(m[3]); if (y < 100) y += y < 50 ? 2000 : 1900;
    return new Date(y, parseInt(m[2])-1, parseInt(m[1]));
  }
  // yyyy-mm-dd
  m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m) return new Date(parseInt(m[1]), parseInt(m[2])-1, parseInt(m[3]));
  return null;
}
function fmtDate(d) {
  if (!d) return '';
  return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
}
function fmtM(v) {
  if (v === undefined || v === null || isNaN(v)) return '0,00';
  return Math.abs(Number(v)).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
}
function parseBRNumber(s) {
  if (typeof s === 'number') return s;
  s = String(s).trim().replace(/\s/g,'');
  // Remove thousand separators (dots) then replace comma decimal
  s = s.replace(/\./g,'').replace(',','.');
  return parseFloat(s);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENGINE DE CÃLCULO PRINCIPAL
//  Implementa a metodologia do Procedimentos.docm
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Dada uma lista de saldos diÃ¡rios {data, saldo} e encargos {data, valor},
 * calcula o resumo mensal comparando cobrado x BACEN S.20741.
 * Retorna { meses[], diario[], totalCobrado, totalLicito, diferenca, periodo }
 */
function calcularPerizia(saldosDiarios, encargos, modo) {
  if (!saldosDiarios.length) throw new Error('Nenhum saldo diÃ¡rio identificado.');
  if (!encargos.length) throw new Error('Nenhum encargo cobrado identificado.');

  // Ordenar
  saldosDiarios.sort((a,b) => a.data - b.data);
  encargos.sort((a,b) => a.data - b.data);

  // Criar mapa de saldo por data
  const saldoMap = {};
  for (const s of saldosDiarios) saldoMap[dtKey(s.data)] = s.saldo;

  // Criar mapa de encargos por data
  const encMap = {};
  for (const e of encargos) {
    const k = dtKey(e.data);
    encMap[k] = (encMap[k] || 0) + e.valor;
  }

  const inicio = saldosDiarios[0].data;
  const fim = saldosDiarios[saldosDiarios.length-1].data;

  // === SÃ‰RIE DIÃRIA ===
  const diario = [];
  let cur = new Date(inicio);
  let saldoAnterior = saldosDiarios[0].saldo;
  let diasUteisAcum = 0;
  let mesRefAnterior = null;
  let saldoJuros = 0; // acumulado de juros compensados

  while (cur <= fim) {
    const dk = dtKey(cur);
    const mk = mesKey(cur);
    const util = isDiaUtil(cur) ? 1 : 0;
    const eom = eomDate(cur);
    const eomK = dtKey(eom);
    const mesRefK = `${cur.getFullYear()}-${String(cur.getMonth()+1).padStart(2,'0')}`;

    // Atualiza contador dias Ãºteis
    if (util === 1) {
      if (mesRefK === mesRefAnterior || mesRefAnterior === null) {
        diasUteisAcum++;
      } else {
        diasUteisAcum = 1;
      }
    }
    if (util === 0 && mesRefK !== mesRefAnterior && mesRefAnterior !== null) {
      diasUteisAcum = 0;
    }
    mesRefAnterior = mesRefK;

    // Saldo do dia (repete anterior se nÃ£o encontrado)
    const saldo = saldoMap[dk] !== undefined ? saldoMap[dk] : saldoAnterior;
    const movimento = saldo - saldoAnterior;
    const encargo = encMap[dk] || 0;
    const saldoNeg = saldo < 0 ? saldo : 0;

    diario.push({
      data: new Date(cur),
      dk, mk,
      util, diasUteisAcum,
      saldo, movimento, encargo, saldoNeg
    });

    saldoAnterior = saldo;
    cur = nextDay(cur);
  }

  // === RESUMO MENSAL ===
  // Para cada mÃªs com encargo, calcular: mÃ©dia saldo devedor, taxa cobrada, encargo BACEN
  const meses = [];
  let totalCobrado = 0, totalLicito = 0;

  // Agrupar encargos por mÃªs de referÃªncia (mÃªs anterior ao lanÃ§amento)
  // Detectar mÃªs de referÃªncia: Ã© o Ãºltimo dia do mÃªs anterior ao lanÃ§amento
  const encargosAgrupados = {};
  for (const e of encargos) {
    // MÃªs de referÃªncia = mÃªs anterior ao lanÃ§amento
    const mesRef = new Date(e.data.getFullYear(), e.data.getMonth()-1, 1);
    const mesRefKey = `${mesRef.getFullYear()}-${String(mesRef.getMonth()+1).padStart(2,'0')}`;
    if (!encargosAgrupados[mesRefKey]) encargosAgrupados[mesRefKey] = { valor: 0, dataLanc: e.data };
    encargosAgrupados[mesRefKey].valor += e.valor;
    if (e.data < encargosAgrupados[mesRefKey].dataLanc) encargosAgrupados[mesRefKey].dataLanc = e.data;
  }

  for (const [mesRefKey, enc] of Object.entries(encargosAgrupados)) {
    const [y, m] = mesRefKey.split('-').map(Number);
    const diasDoMes = diario.filter(d => d.data.getFullYear()===y && d.data.getMonth()+1===m);
    if (!diasDoMes.length) continue;

    // MÃ©dia dos saldos negativos
    let somaSaldos = 0, qtdDias = 0;
    if (modo === 'uteis') {
      const maxUtil = diasDoMes[diasDoMes.length-1].diasUteisAcum;
      somaSaldos = diasDoMes.filter(d=>d.util===1).reduce((a,d)=>a+d.saldoNeg,0);
      qtdDias = maxUtil;
    } else {
      somaSaldos = diasDoMes.reduce((a,d)=>a+d.saldoNeg,0);
      qtdDias = diasDoMes.length;
    }
    const mediaSaldo = qtdDias > 0 ? somaSaldos / qtdDias : 0;

    // Taxa cobrada (% sobre a mÃ©dia)
    const taxaCobrada = mediaSaldo < 0 && enc.valor > 0 ? enc.valor / Math.abs(mediaSaldo) : 0;

    // Taxa BACEN
    const taxaBacen = BACEN[mesRefKey] || 0;

    // Encargo lÃ­cito = menor taxa Ã— |mÃ©dia|
    const taxaAplicada = Math.min(taxaCobrada, taxaBacen);
    const encargoLicito = Math.abs(mediaSaldo) * taxaAplicada;

    const diferenca = enc.valor - encargoLicito;
    totalCobrado += enc.valor;
    totalLicito += encargoLicito;

    const [my, mm] = mesRefKey.split('-');
    const nomeMes = new Date(parseInt(my), parseInt(mm)-1, 1)
      .toLocaleDateString('pt-BR',{month:'short',year:'numeric'});

    meses.push({
      mesRefKey, nomeMes,
      mediaSaldo, qtdDias,
      taxaCobrada: (taxaCobrada*100),
      taxaBacen: (taxaBacen*100),
      encargoCobrado: enc.valor,
      encargoLicito,
      diferenca,
      dataLanc: enc.dataLanc
    });
  }

  meses.sort((a,b) => a.mesRefKey.localeCompare(b.mesRefKey));

  const periodo = meses.length ?
    `${meses[0].nomeMes} a ${meses[meses.length-1].nomeMes}` : 'â€”';

  return {
    meses, diario,
    totalCobrado, totalLicito,
    diferenca: totalCobrado - totalLicito,
    periodo, modo,
    saldosDiarios: saldosDiarios.length,
    encargosCount: encargos.length
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARSER DE EXTRATO PDF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

async function parsePDF(file) {
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: buf}).promise;

  let fullText = '';
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    // Reconstruct with X position for better column detection
    const items = content.items.sort((a,b) => {
      const ay = Math.round(a.transform[5] / 5) * 5;
      const by = Math.round(b.transform[5] / 5) * 5;
      if (ay !== by) return by - ay;
      return a.transform[4] - b.transform[4];
    });
    let lastY = null;
    for (const item of items) {
      const y = Math.round(item.transform[5] / 4) * 4;
      if (lastY !== null && y !== lastY) fullText += '\n';
      fullText += item.str + ' ';
      lastY = y;
    }
    fullText += '\n';
  }

  return parsePDFText(fullText);
}

function parsePDFText(text) {
  const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 2);
  const saldos = [];
  const encargos = [];

  // Regex: data dd/mm/yy ou dd/mm/yyyy
  const dateRx = /\b(\d{2})[\/\-\.](\d{2})[\/\-\.](\d{2,4})\b/;

  // Encargos: IOF, encargos limite crÃ©dito, juros cheque especial
  const encKw = /encargo|iof\s+s\/|juros\s+cheque|taxa\s+cheque/i;
  // Saldos explÃ­citos
  const saldoKw = /saldo\s+em\s+|saldo\s+anterior|saldo\s+final/i;
  // Movimentos a ignorar para extraÃ§Ã£o de saldo
  const ignoraKw = /poupan|baixa\s+auto|transf|ted\s+|pix\s+|pagto\s+elet|saque\s+|aplicac|compra\s+|debito\s+auto|boleto/i;

  // Extrai valor numÃ©rico de string com sufixos BR (CR, DV, D, â€“ -)
  function extractVal(s) {
    // Remove espaÃ§os internos
    s = s.trim();
    // Detectar sufixo devedor
    const isDev = /DV$|D\s*$|\u2013$|-$/.test(s) || /â€“\s*$/.test(s);
    const isCred = /CR$/.test(s.toUpperCase());
    // Limpar: remover sufixos e sinais finais
    const clean = s.replace(/\s*(CR|DV|D)\s*$/i,'').replace(/[\u2013\-]\s*$/,'').trim();
    // Converter nÃºmero BR
    const num = parseFloat(clean.replace(/\./g,'').replace(',','.'));
    if (isNaN(num)) return null;
    if (isDev) return -Math.abs(num);
    if (isCred) return Math.abs(num);
    return num;
  }

  // Encontra todos os valores monetÃ¡rios na linha (com sufixos opcionais)
  function findVals(line) {
    const rx = /\d{1,3}(?:\.\d{3})*,\d{2}\s*(?:CR|DV|D(?!\w))?(?:\s*[\u2013\-](?!\d))?/gi;
    return [...line.matchAll(rx)].map(m => extractVal(m[0])).filter(v => v !== null);
  }

  for (const line of lines) {
    const dm = line.match(dateRx);
    if (!dm) continue;

    let y = parseInt(dm[3]);
    if (y < 100) y += y < 50 ? 2000 : 1900;
    if (y < 2000 || y > 2035) continue;
    const data = new Date(y, parseInt(dm[2])-1, parseInt(dm[1]));
    if (isNaN(data.getTime())) continue;

    const vals = findVals(line);
    if (!vals.length) continue;

    // ENCARGOS
    if (encKw.test(line)) {
      const v = Math.abs(vals[0]);
      if (v > 0) encargos.push({ data, valor: v, hist: line.substring(0,60) });
      continue;
    }

    // SALDO EXPLÃCITO
    if (saldoKw.test(line)) {
      const v = vals[vals.length - 1];
      if (v !== null) {
        const ex = saldos.find(s => dtKey(s.data) === dtKey(data));
        if (!ex) saldos.push({ data, saldo: v });
        else ex.saldo = v;
      }
      continue;
    }

    // SALDO IMPLÃCITO: Ãºltimo valor da linha (nÃ£o Ã© movimento conhecido)
    if (!ignoraKw.test(line)) {
      const v = vals[vals.length - 1];
      if (v !== null && Math.abs(v) > 0.01) {
        const ex = saldos.find(s => dtKey(s.data) === dtKey(data));
        if (!ex) saldos.push({ data, saldo: v });
        else ex.saldo = v;
      }
    }
  }

  return { saldos, encargos, rawText: text, fonte: 'pdf' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARSER EXCEL/CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function parseExcel(file) {
  const buf = await file.arrayBuffer();
  const wb = XLSX.read(buf, {type:'array', cellDates:true});
  const ws = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:'', raw:false});

  const saldos = [];
  const encargos = [];

  const encKw = /encargo|juros|tarifa|iof|taxa|cheque\s+esp|excesso|limite/i;

  for (const row of rows) {
    if (!row.length) continue;
    // Find date column
    let data = null;
    let dateCol = -1;
    for (let i = 0; i < row.length; i++) {
      const d = parseDate(row[i]);
      if (d && d.getFullYear() > 2000 && d.getFullYear() < 2030) {
        data = d; dateCol = i; break;
      }
    }
    if (!data) continue;

    // Find numeric values
    const nums = [];
    for (let i = 0; i < row.length; i++) {
      if (i === dateCol) continue;
      const n = parseBRNumber(row[i]);
      if (!isNaN(n) && Math.abs(n) > 0.01) nums.push({col:i, val:n});
    }
    if (!nums.length) continue;

    const lineText = row.join(' ');
    if (encKw.test(lineText)) {
      const v = nums.find(n => n.val > 0);
      if (v) encargos.push({ data, valor: v.val, hist: lineText.substring(0,50) });
    } else {
      const saldo = nums[nums.length-1].val;
      const existing = saldos.find(s => dtKey(s.data) === dtKey(data));
      if (!existing) saldos.push({ data, saldo });
      else existing.saldo = saldo;
    }
  }

  return { saldos, encargos, fonte: 'excel' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXTRAÃ‡ÃƒO VIA CLAUDE API (PDF escaneado)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function extrairViaAI(rawText) {
  if (!state.apiKey) throw new Error('Configure a chave Claude para extrair PDFs escaneados.');

  const prompt = `VocÃª Ã© um sistema de extraÃ§Ã£o de dados de extratos bancÃ¡rios brasileiros.

Analise o texto abaixo e extraia:
1. SALDOS DIÃRIOS: data e saldo de cada dia (mesmo que seja repetiÃ§Ã£o do dia anterior)
2. ENCARGOS: data e valor de cada lanÃ§amento de encargos (cheque especial, excesso de limite, juros)

TEXTO DO EXTRATO:
${rawText.substring(0, 6000)}

Responda APENAS em JSON vÃ¡lido, sem markdown:
{
  "saldos": [{"data": "DD/MM/YYYY", "saldo": -1234.56}],
  "encargos": [{"data": "DD/MM/YYYY", "valor": 234.56, "historico": "ENCARGOS CHEQUE ESPECIAL"}]
}

IMPORTANTE:
- Saldos devedores sÃ£o NEGATIVOS
- Encargos sÃ£o POSITIVOS (dÃ©bito na conta)
- Inclua TODOS os dias com saldo informado no extrato`;

  const resp = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type':'application/json',
      'x-api-key':state.apiKey,
      'anthropic-version':'2023-06-01',
      'anthropic-dangerous-direct-browser-ipc':'true'
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514', max_tokens: 4000,
      messages: [{role:'user', content: prompt}]
    })
  });
  if (!resp.ok) throw new Error('Erro API Claude: ' + resp.status);
  const data = await resp.json();
  let txt = data.content[0].text.replace(/```json|```/g,'').trim();
  const parsed = JSON.parse(txt);

  const saldos = (parsed.saldos||[]).map(s => ({
    data: parseDate(s.data), saldo: Number(s.saldo)
  })).filter(s => s.data);
  const encargos = (parsed.encargos||[]).map(e => ({
    data: parseDate(e.data), valor: Number(e.valor), hist: e.historico
  })).filter(e => e.data);

  return { saldos, encargos, fonte: 'ai' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARECER JURÃDICO VIA CLAUDE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function gerarParecer(res, cliente, banco) {
  if (!state.apiKey) return gerarParecerDemo(res, cliente, banco);

  const prompt = `VocÃª Ã© perito contÃ¡bil e jurÃ­dico especializado em direito bancÃ¡rio brasileiro. Elabore um parecer tÃ©cnico-pericial com base nos dados calculados pelo sistema Modus.

DADOS DO CASO:
Cliente: ${cliente}
Banco: ${banco}
PerÃ­odo: ${res.periodo}
Modalidade: Dias ${res.modo === 'uteis' ? 'Ãšteis' : 'Corridos'}
Registros analisados: ${res.saldosDiarios} saldos diÃ¡rios, ${res.encargosCount} lanÃ§amentos de encargos

RESULTADO APURADO:
Total cobrado pelo banco: R$ ${fmtM(res.totalCobrado)}
Total lÃ­cito (BACEN SÃ©rie 20741): R$ ${fmtM(res.totalLicito)}
DIFERENÃ‡A A RESTITUIR: R$ ${fmtM(res.diferenca)}
Percentual de excesso: ${res.totalCobrado > 0 ? ((res.diferenca/res.totalCobrado)*100).toFixed(1) : 0}%

DETALHAMENTO MENSAL (primeiros 8 meses):
${res.meses.slice(0,8).map(m => `${m.nomeMes}: MÃ©dia R$${fmtM(Math.abs(m.mediaSaldo))} | Cobrado R$${fmtM(m.encargoCobrado)} (${m.taxaCobrada.toFixed(2)}%a.m.) | LÃ­cito R$${fmtM(m.encargoLicito)} (${m.taxaBacen.toFixed(2)}%a.m.) | Dif. R$${fmtM(m.diferenca)}`).join('\n')}

Elabore:
1. CARACTERIZAÃ‡ÃƒO DA IRREGULARIDADE
2. FUNDAMENTAÃ‡ÃƒO LEGAL (cite SÃºmulas STF/STJ, ResoluÃ§Ãµes BACEN, CÃ³digo Civil)
3. METODOLOGIA ADOTADA (explique a metodologia de cÃ¡lculo empregada)
4. RESULTADO E CONCLUSÃƒO PERICIAL
5. RECOMENDAÃ‡ÃƒO JURÃDICA

Seja tÃ©cnico, objetivo e use terminologia jurÃ­dico-contÃ¡bil adequada. MÃ¡ximo 600 palavras.`;

  const resp = await fetch('https://api.anthropic.com/v1/messages', {
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'x-api-key':state.apiKey,
      'anthropic-version':'2023-06-01',
      'anthropic-dangerous-direct-browser-ipc':'true'
    },
    body: JSON.stringify({
      model:'claude-sonnet-4-20250514', max_tokens:1000,
      messages:[{role:'user',content:prompt}]
    })
  });
  if (!resp.ok) throw new Error('Erro API: '+resp.status);
  const d = await resp.json();
  return d.content[0].text;
}

function gerarParecerDemo(res, cliente, banco) {
  const pct = res.totalCobrado > 0 ? ((res.diferenca/res.totalCobrado)*100).toFixed(1) : 0;
  return `PARECER TÃ‰CNICO-PERICIAL
Modus Tecnologia JurÃ­dica Â· Sistema de AnÃ¡lise Pericial v2
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

CLIENTE: ${cliente || 'NÃ£o informado'}
BANCO ANALISADO: ${banco || 'NÃ£o informado'}
PERÃODO: ${res.periodo}
METODOLOGIA: Dias ${res.modo === 'uteis' ? 'Ãšteis' : 'Corridos'}

1. CARACTERIZAÃ‡ÃƒO DA IRREGULARIDADE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
A anÃ¡lise dos ${res.saldosDiarios} registros diÃ¡rios e ${res.encargosCount} lanÃ§amentos de encargos evidencia a prÃ¡tica de anatocismo â€” capitalizaÃ§Ã£o de juros sobre juros vencidos â€” e a aplicaÃ§Ã£o de taxas superiores Ã s divulgadas pelo Banco Central do Brasil para operaÃ§Ãµes de cheque especial (SÃ©rie 20741).

2. FUNDAMENTAÃ‡ÃƒO LEGAL
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ SÃºmula 121 STF: vedaÃ§Ã£o Ã  capitalizaÃ§Ã£o de juros, ainda que expressamente convencionada
â€¢ SÃºmula 539 STJ: possibilidade de capitalizaÃ§Ã£o mensal apenas quando expressamente pactuada
â€¢ Art. 591 c/c art. 406 CC/2002: juros compostos dependem de previsÃ£o contratual expressa
â€¢ ResoluÃ§Ã£o CMN nÂº 4.558/2017 e ResoluÃ§Ã£o CMN nÂº 4.999/2022: transparÃªncia em operaÃ§Ãµes de crÃ©dito
â€¢ SÃ©rie BACEN 20741: taxa mÃ©dia de juros â€” cheque especial â€” pessoa fÃ­sica

3. METODOLOGIA ADOTADA
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
O sistema Modus implementou a seguinte metodologia:
a) ReconstituiÃ§Ã£o da sÃ©rie de saldos diÃ¡rios a partir do extrato importado
b) IdentificaÃ§Ã£o e separaÃ§Ã£o dos lanÃ§amentos de encargos cobrados
c) CÃ¡lculo da mÃ©dia aritmÃ©tica dos saldos devedores diÃ¡rios por perÃ­odo (dias ${res.modo === 'uteis' ? 'Ãºteis' : 'corridos'})
d) AplicaÃ§Ã£o sobre a mÃ©dia da menor taxa entre: (i) a efetivamente cobrada pelo banco e (ii) a Taxa BACEN SÃ©rie 20741 do perÃ­odo correspondente
e) ApuraÃ§Ã£o da diferenÃ§a entre encargo cobrado e encargo lÃ­cito

4. RESULTADO PERICIAL
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Total de encargos cobrados:        R$ ${fmtM(res.totalCobrado)}
Total de encargos lÃ­citos:         R$ ${fmtM(res.totalLicito)}
DIFERENÃ‡A APURADA (a restituir):   R$ ${fmtM(res.diferenca)}
Percentual de excesso:             ${pct}%

5. CONCLUSÃƒO E RECOMENDAÃ‡ÃƒO
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Constatou-se cobranÃ§a indevida de R$ ${fmtM(res.diferenca)} no perÃ­odo analisado, configurando enriquecimento sem causa da instituiÃ§Ã£o financeira (art. 884 CC/2002).

Recomenda-se: (i) aÃ§Ã£o revisional de contrato bancÃ¡rio com pedido de repetiÃ§Ã£o do indÃ©bito em dobro (art. 42 CDC) ou simples (art. 876 CC), conforme a natureza da relaÃ§Ã£o jurÃ­dica; (ii) observÃ¢ncia do prazo prescricional de 10 anos (art. 205 CC) para a pretensÃ£o revisional e 3 anos (art. 206 Â§3Â° IV CC) para repetiÃ§Ã£o de parcelas vencidas.

âš ï¸ Configure a chave API Claude para gerar um parecer personalizado com anÃ¡lise detalhada do caso.`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ESTADO GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  apiKey: '',
  cases: [],
  currentCase: null,
  parsedData: null,
  chatHistory: [],
  chatCtx: null,
  charts: {}
};
try { const s = localStorage.getItem('modus_v2'); if(s) state.cases = JSON.parse(s); } catch(e){}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVEGAÃ‡ÃƒO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function go(v) {
  document.querySelectorAll('.view').forEach(x => x.classList.remove('on'));
  document.querySelectorAll('.nav').forEach(x => x.classList.remove('on'));
  const vEl = document.getElementById('v-'+v);
  const nEl = document.getElementById('n-'+v);
  if (vEl) vEl.classList.add('on');
  if (nEl) nEl.classList.add('on');
  if (v==='dash') renderDash();
  if (v==='chat') populateCtx();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API KEY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onKey(v) {
  state.apiKey = v.trim();
  document.getElementById('dot').className = 'api-dot' + (v.startsWith('sk-ant-') ? ' on' : '');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const upZone = document.getElementById('upZone');
upZone.addEventListener('dragover', e=>{e.preventDefault();upZone.classList.add('drag')});
upZone.addEventListener('dragleave', ()=>upZone.classList.remove('drag'));
upZone.addEventListener('drop', e=>{e.preventDefault();upZone.classList.remove('drag');handleFile(e.dataTransfer.files[0])});

async function handleFile(file) {
  if (!file) return;
  document.getElementById('fStatus').style.display='block';
  document.getElementById('fName').textContent = file.name;
  document.getElementById('fInfo').textContent = `${(file.size/1024).toFixed(1)} KB`;
  document.getElementById('fConf').textContent = 'â³ Processando...';

  try {
    const ext = file.name.split('.').pop().toLowerCase();
    let parsed;
    if (ext === 'pdf') {
      parsed = await parsePDF(file);
      // Se PDF nÃ£o extraiu dados suficientes
      if (parsed.saldos.length < 3) {
        if (state.apiKey && state.apiKey.startsWith('sk-ant-')) {
          document.getElementById('fConf').textContent = 'ğŸ¤– Extraindo via IA...';
          try {
            parsed = await extrairViaAI(parsed.rawText || '');
            parsed.fonte = 'ai';
          } catch(aiErr) {
            toast('ExtraÃ§Ã£o IA: ' + aiErr.message, 'err');
          }
        } else if (parsed.saldos.length === 0) {
          toast('PDF nÃ£o reconhecido. Configure a chave Claude para extraÃ§Ã£o via IA, ou use um PDF nativo exportado do internet banking.', 'err');
        }
      }
    } else {
      parsed = await parseExcel(file);
    }

    state.parsedData = parsed;
    const conf = parsed.fonte === 'ai' ? 'ğŸ¤– ExtraÃ­do via Claude AI' :
                 parsed.fonte === 'pdf' ? 'âœ“ PDF nativo processado' : 'âœ“ Excel processado';
    document.getElementById('fConf').textContent = conf;

    showPreview(parsed);
    document.getElementById('btnAn').disabled = !parsed.saldos.length;

    if (!parsed.saldos.length) toast('Nenhum saldo identificado. Verifique se o PDF Ã© nativo (nÃ£o escaneado) ou configure a chave Claude.', 'err');
    else toast(`${parsed.saldos.length} saldos e ${parsed.encargos.length} encargos identificados`, 'ok');

  } catch(e) {
    toast('Erro: ' + e.message, 'err');
    document.getElementById('fConf').textContent = 'âœ— Erro na extraÃ§Ã£o';
  }
}

function showPreview(parsed) {
  const wrap = document.getElementById('prevWrap');
  const table = document.getElementById('prevTable');
  wrap.style.display = 'block';

  const maxRows = 6;
  let html = `<thead><tr><th colspan="5">Saldos DiÃ¡rios (${parsed.saldos.length} registros)</th></tr><tr><th>Data</th><th>Saldo</th></tr></thead><tbody>`;
  parsed.saldos.slice(0, maxRows).forEach(s => {
    html += `<tr><td>${fmtDate(s.data)}</td><td class="${s.saldo<0?'tr-neg':'tr-pos'}">${s.saldo<0?'-':''}R$ ${fmtM(s.saldo)}</td></tr>`;
  });
  if (parsed.saldos.length > maxRows) html += `<tr><td colspan="2" style="text-align:center;font-family:'DM Mono',monospace;font-size:.62rem;color:var(--muted)">+ ${parsed.saldos.length-maxRows} registros</td></tr>`;
  html += `</tbody>`;

  if (parsed.encargos.length) {
    html += `<thead><tr><th colspan="3" style="padding-top:1rem">Encargos Identificados (${parsed.encargos.length})</th></tr><tr><th>Data</th><th>Valor</th></tr></thead><tbody>`;
    parsed.encargos.slice(0, maxRows).forEach(e => {
      html += `<tr><td>${fmtDate(e.data)}</td><td class="tr-neg">R$ ${fmtM(e.valor)}</td></tr>`;
    });
    html += '</tbody>';
  }
  table.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANALISAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function analisar() {
  if (!state.parsedData || !state.parsedData.saldos.length) return toast('Importe um extrato com dados vÃ¡lidos.','err');
  const cli = document.getElementById('f-cli').value.trim();
  if (!cli) return toast('Informe o nome do cliente.','err');

  document.getElementById('procWrap').style.display='block';
  document.getElementById('resWrap').style.display='none';
  document.getElementById('btnAn').disabled=true;

  const steps = [
    {id:'s1', label:'Validando e ordenando dados do extrato'},
    {id:'s2', label:'Construindo sÃ©rie diÃ¡ria com dias Ãºteis e feriados'},
    {id:'s3', label:'Aplicando metodologia dos juros compensados (6 hipÃ³teses)'},
    {id:'s4', label:'Calculando mÃ©dias mensais dos saldos devedores'},
    {id:'s5', label:'Comparando com taxas BACEN SÃ©rie 20741'},
    {id:'s6', label:'Apurando diferenÃ§as e gerando resumo'},
    {id:'s7', label:'Elaborando parecer jurÃ­dico com I.A.'},
  ];
  renderSteps(steps);

  try {
    const modo = document.getElementById('f-modo').value;
    const banco = document.getElementById('f-banco').value;
    const proc = document.getElementById('f-proc').value;

    await delay(300); markStep('s1', true);
    await delay(200); markStep('s2', true);
    await delay(300); markStep('s3', true);

    // CÃLCULO REAL
    const res = calcularPerizia(state.parsedData.saldos, state.parsedData.encargos, modo);
    await delay(200); markStep('s4', true);
    await delay(200); markStep('s5', true);
    await delay(200); markStep('s6', true);

    // PARECER
    const parecer = await gerarParecer(res, cli, banco);
    markStep('s7', true);

    res.aiAnalysis = parecer;
    res.cliente = cli; res.banco = banco; res.processo = proc;
    res.dataAnalise = new Date().toLocaleDateString('pt-BR');
    res.fonte = state.parsedData.fonte;

    state.currentCase = res;
    renderResult(res);

  } catch(e) {
    toast('Erro no cÃ¡lculo: ' + e.message, 'err');
    console.error(e);
  }

  document.getElementById('btnAn').disabled = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER RESULTADO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderResult(res) {
  document.getElementById('resWrap').style.display='block';
  document.getElementById('procWrap').style.display='none';

  document.getElementById('r-dif').textContent = 'R$ ' + fmtM(res.diferenca);
  document.getElementById('r-cob').textContent = 'R$ ' + fmtM(res.totalCobrado);
  document.getElementById('r-lic').textContent = 'R$ ' + fmtM(res.totalLicito);
  document.getElementById('r-per').textContent = 'PerÃ­odo: ' + res.periodo + ' Â· ' + res.meses.length + ' meses';
  document.getElementById('r-conf').innerHTML = `<span class="conf-badge conf-real">âœ“ CÃ¡lculo Real Â· Metodologia Pericial</span>`;

  // Tabela mensal
  const tMes = document.getElementById('tMes');
  let h = `<thead><tr><th>MÃªs Ref.</th><th>Dias</th><th>MÃ©dia Saldo</th><th>Taxa Cobrada</th><th>Cobrado</th><th>Taxa BACEN</th><th>LÃ­cito</th><th>DiferenÃ§a</th></tr></thead><tbody>`;
  let tcob=0, tlic=0;
  for (const m of res.meses) {
    tcob+=m.encargoCobrado; tlic+=m.encargoLicito;
    const cls = m.diferenca > 0 ? 'tr-neg' : 'tr-pos';
    h += `<tr>
      <td style="font-weight:600">${m.nomeMes}</td>
      <td class="tn">${m.qtdDias}</td>
      <td class="tr-neg">${fmtM(m.mediaSaldo)}</td>
      <td class="tn">${m.taxaCobrada.toFixed(4)}%</td>
      <td class="tr-neg">${fmtM(m.encargoCobrado)}</td>
      <td class="tn">${m.taxaBacen.toFixed(4)}%</td>
      <td class="tr-pos">${fmtM(m.encargoLicito)}</td>
      <td class="${cls}"><strong>${fmtM(m.diferenca)}</strong></td>
    </tr>`;
  }
  h += `<tr style="background:var(--cream);font-weight:700">
    <td colspan="4"><strong>TOTAL</strong></td>
    <td class="tr-neg"><strong>R$ ${fmtM(tcob)}</strong></td><td></td>
    <td class="tr-pos"><strong>R$ ${fmtM(tlic)}</strong></td>
    <td class="tr-neg"><strong>R$ ${fmtM(tcob-tlic)}</strong></td>
  </tr></tbody>`;
  tMes.innerHTML = h;

  // Tabela diÃ¡ria (primeiros 60 dias)
  const tDia = document.getElementById('tDia');
  let hd = `<thead><tr><th>Data</th><th>Ãštil</th><th>Dias Ãšteis</th><th>Saldo</th><th>Movimento</th><th>Encargo</th></tr></thead><tbody>`;
  for (const d of res.diario.slice(0, 60)) {
    hd += `<tr>
      <td style="font-family:'DM Mono',monospace;font-size:.72rem">${fmtDate(d.data)}</td>
      <td class="tn" style="font-family:'DM Mono',monospace">${d.util ? 'âœ“' : 'â€”'}</td>
      <td class="tn">${d.diasUteisAcum}</td>
      <td class="${d.saldo<0?'tr-neg':'tr-pos'}">${d.saldo<0?'-':''}${fmtM(d.saldo)}</td>
      <td class="${d.movimento<0?'tr-neg':'tr-pos'}">${d.movimento!==0?(d.movimento<0?'-':'+')+fmtM(d.movimento):''}</td>
      <td class="${d.encargo?'tr-neg':''}">${d.encargo?fmtM(d.encargo):''}</td>
    </tr>`;
  }
  if (res.diario.length > 60) hd += `<tr><td colspan="6" style="text-align:center;font-family:'DM Mono',monospace;font-size:.62rem;color:var(--muted)">Exportar Excel para ver todos os ${res.diario.length} dias</td></tr>`;
  hd += '</tbody>';
  tDia.innerHTML = hd;

  // Parecer
  document.getElementById('aiTxt').textContent = res.aiAnalysis || '';

  // GrÃ¡fico
  renderResChart(res);
}

function renderResChart(res) {
  if (state.charts.res) state.charts.res.destroy();
  const ctx = document.getElementById('chRes').getContext('2d');
  state.charts.res = new Chart(ctx, {
    type:'bar',
    data:{
      labels: res.meses.map(m=>m.nomeMes),
      datasets:[
        {label:'Cobrado',data:res.meses.map(m=>+m.encargoCobrado.toFixed(2)),backgroundColor:'rgba(192,57,43,.75)',borderRadius:3},
        {label:'LÃ­cito BACEN',data:res.meses.map(m=>+m.encargoLicito.toFixed(2)),backgroundColor:'rgba(26,107,58,.75)',borderRadius:3}
      ]
    },
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{labels:{font:{family:'DM Mono',size:10}}}},
      scales:{
        x:{ticks:{font:{family:'DM Mono',size:9}}},
        y:{ticks:{font:{family:'DM Mono',size:9},callback:v=>'R$'+fmtM(v)}}
      }
    }
  });
}

function rTab(el, id) {
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  el.classList.add('on');
  ['rt-res','rt-dia','rt-ai','rt-gr'].forEach(x=>{
    document.getElementById(x).style.display = x===id?'block':'none';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSteps(steps) {
  document.getElementById('procSteps').innerHTML = steps.map(s =>
    `<div class="step" id="${s.id}"><div class="step-ic"><span class="spin"></span></div><div class="step-txt">${s.label}</div></div>`
  ).join('');
}
function markStep(id, ok) {
  const el = document.getElementById(id);
  if (!el) return;
  el.className = 'step ' + (ok ? 'done' : 'err');
  el.querySelector('.step-ic').innerHTML = ok ? 'âœ“' : 'âœ—';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SALVAR / EXPORTAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function salvar() {
  const c = state.currentCase;
  if (!c) return;
  if (!state.cases.find(x=>x.id===c.id)) {
    c.id = Date.now();
    state.cases.push({...c});
    try { localStorage.setItem('modus_v2', JSON.stringify(state.cases.map(x=>({...x,diario:undefined})))); } catch(e){}
  }
  renderSidebar();
  document.getElementById('overlay').classList.add('on');
}

function exportar() {
  const c = state.currentCase;
  if (!c) return toast('Nenhum resultado para exportar.','err');
  const wb = XLSX.utils.book_new();

  // Resumo
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([
    ['MODUS Â· ANÃLISE PERICIAL DE CONTA CORRENTE'],[''],
    ['Cliente:',c.cliente,'Processo:',c.processo],
    ['Banco:',c.banco,'PerÃ­odo:',c.periodo],
    ['Metodologia:','Dias '+( c.modo==='uteis'?'Ãšteis':'Corridos'),'Data:',c.dataAnalise],[''],
    ['RESULTADO'],
    ['Total Cobrado:',c.totalCobrado],
    ['Total LÃ­cito (BACEN S.20741):',c.totalLicito],
    ['DIFERENÃ‡A:',c.diferenca],
  ]), 'Resumo');

  // Mensal
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([
    ['MÃªs Ref.','Dias','MÃ©dia Saldo Devedor','Taxa Cobrada %','Encargo Cobrado','Taxa BACEN %','Encargo LÃ­cito','DiferenÃ§a'],
    ...c.meses.map(m=>[m.nomeMes,m.qtdDias,m.mediaSaldo,m.taxaCobrada,m.encargoCobrado,m.taxaBacen,m.encargoLicito,m.diferenca])
  ]), 'Detalhamento Mensal');

  // DiÃ¡rio
  if (c.diario?.length) {
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([
      ['Data','Dia Ãštil','Dias Ãšteis Acum.','Saldo','Movimento','Encargo'],
      ...c.diario.map(d=>[fmtDate(d.data),d.util?'SIM':'NÃƒO',d.diasUteisAcum,d.saldo,d.movimento,d.encargo||''])
    ]), 'SÃ©rie DiÃ¡ria');
  }

  // Parecer
  if (c.aiAnalysis) XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([['PARECER PERICIAL'],[''],[ c.aiAnalysis]]), 'Parecer');

  XLSX.writeFile(wb, `Modus_${c.cliente?.replace(/\s+/g,'_')||'caso'}_${c.dataAnalise?.replace(/\//g,'-')}.xlsx`);
  toast('Exportado com sucesso!','ok');
}

function closeM() { document.getElementById('overlay').classList.remove('on'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDash() {
  const cs = state.cases;
  document.getElementById('d-total').textContent = cs.length;
  const tc = cs.reduce((a,c)=>a+c.totalCobrado,0);
  const tl = cs.reduce((a,c)=>a+c.totalLicito,0);
  const td = cs.reduce((a,c)=>a+c.diferenca,0);
  document.getElementById('d-cob').textContent = 'R$ '+fmtM(tc);
  document.getElementById('d-lic').textContent = 'R$ '+fmtM(tl);
  document.getElementById('d-dif').textContent = 'R$ '+fmtM(td);

  // Table
  const dt = document.getElementById('d-table');
  if (!cs.length) {
    dt.innerHTML = `<div class="ct">Casos</div><div style="text-align:center;padding:3rem;color:var(--muted)"><div style="font-size:2rem;margin-bottom:.75rem">ğŸ“‚</div><div style="font-family:'DM Serif Display',serif;font-size:1.1rem;color:var(--ink);margin-bottom:.4rem">Nenhum caso salvo</div><div style="font-size:.8rem">Clique em "+ Novo Caso" para comeÃ§ar</div></div>`;
  } else {
    let h = `<div class="ct">Todos os Casos</div><div class="tw"><table><thead><tr><th>Cliente</th><th>Processo</th><th>Banco</th><th>PerÃ­odo</th><th>Cobrado</th><th>LÃ­cito</th><th>DiferenÃ§a</th><th>Fonte</th></tr></thead><tbody>`;
    for (const c of cs) {
      h += `<tr style="cursor:pointer" onclick="openCase(${c.id})">
        <td><strong>${c.cliente}</strong></td>
        <td style="font-family:'DM Mono',monospace;font-size:.7rem">${c.processo||'â€”'}</td>
        <td>${c.banco||'â€”'}</td>
        <td style="font-family:'DM Mono',monospace;font-size:.7rem">${c.periodo}</td>
        <td class="tr-neg">R$ ${fmtM(c.totalCobrado)}</td>
        <td class="tr-pos">R$ ${fmtM(c.totalLicito)}</td>
        <td class="tr-neg"><strong>R$ ${fmtM(c.diferenca)}</strong></td>
        <td style="font-family:'DM Mono',monospace;font-size:.65rem">${c.fonte||'â€”'}</td>
      </tr>`;
    }
    dt.innerHTML = h + '</tbody></table></div>';
  }

  // Charts
  if (state.charts.c1) state.charts.c1.destroy();
  if (state.charts.c2) state.charts.c2.destroy();
  const c1 = document.getElementById('ch1').getContext('2d');
  const c2 = document.getElementById('ch2').getContext('2d');
  if (cs.length) {
    state.charts.c1 = new Chart(c1, {type:'bar',data:{
      labels:cs.map(c=>c.cliente?.split(' ')[0]||'Caso'),
      datasets:[
        {label:'Cobrado',data:cs.map(c=>+c.totalCobrado.toFixed(2)),backgroundColor:'rgba(192,57,43,.75)',borderRadius:3},
        {label:'LÃ­cito',data:cs.map(c=>+c.totalLicito.toFixed(2)),backgroundColor:'rgba(26,107,58,.75)',borderRadius:3}
      ]
    },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{font:{family:'DM Mono',size:10}}}},scales:{x:{ticks:{font:{family:'DM Mono',size:9}}},y:{ticks:{font:{family:'DM Mono',size:9},callback:v=>'R$'+fmtM(v)}}}}});
    state.charts.c2 = new Chart(c2, {type:'doughnut',data:{
      labels:['Com resultado'],datasets:[{data:[cs.length],backgroundColor:['#c8a84b'],borderWidth:0}]
    },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{font:{family:'DM Mono',size:10}}}}}});
  } else {
    [c1,c2].forEach(ctx=>{ctx.font='12px DM Mono';ctx.fillStyle='#aaa';ctx.fillText('Nenhum dado',50,80)});
  }
  renderSidebar();
}

function openCase(id) {
  const c = state.cases.find(x=>x.id===id);
  if (!c) return;
  state.currentCase = c;
  go('caso');
  document.getElementById('caso-t').innerHTML = `Caso <em>${c.cliente}</em>`;
  document.getElementById('caso-s').textContent = `${c.processo||'â€”'} Â· ${c.banco||'â€”'} Â· ${c.periodo}`;
  document.getElementById('casoC').innerHTML = `
    <div class="g4 gap">
      <div class="sc danger"><div class="sl">Cobrado</div><div class="sv neg">R$ ${fmtM(c.totalCobrado)}</div></div>
      <div class="sc ok"><div class="sl">LÃ­cito BACEN</div><div class="sv pos">R$ ${fmtM(c.totalLicito)}</div></div>
      <div class="sc danger"><div class="sl">DiferenÃ§a</div><div class="sv neg">R$ ${fmtM(c.diferenca)}</div></div>
      <div class="sc"><div class="sl">Meses</div><div class="sv">${c.meses?.length||0}</div></div>
    </div>
    <div class="card"><div class="ct">Parecer Pericial</div><div style="font-size:.8rem;line-height:1.75;white-space:pre-wrap">${c.aiAnalysis||'â€”'}</div></div>`;
}

function renderSidebar() {
  const el = document.getElementById('cList');
  if (!state.cases.length) { el.innerHTML='<div style="font-family:\'DM Mono\',monospace;font-size:.62rem;color:#333;padding:.4rem .5rem">Nenhum caso salvo</div>'; return; }
  el.innerHTML = state.cases.map(c=>`
    <div class="case-item" onclick="openCase(${c.id})">
      <div class="ci-name">${c.cliente||'Sem nome'}</div>
      <div class="ci-meta">${c.processo||'â€”'} Â· ${c.dataAnalise||''}</div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateCtx() {
  const sel = document.getElementById('chatCase');
  sel.innerHTML = '<option value="">Sem caso selecionado</option>' +
    state.cases.map(c=>`<option value="${c.id}">${c.cliente} Â· ${c.processo||'S/N'}</option>`).join('');
}
function loadCtx() {
  const id = parseInt(document.getElementById('chatCase').value);
  const el = document.getElementById('ctxSum');
  if (!id) { el.style.display='none'; state.chatCtx=null; return; }
  const c = state.cases.find(x=>x.id===id);
  if (!c) return;
  state.chatCtx = c;
  el.style.display='block';
  el.innerHTML = `<strong>${c.cliente}</strong> Â· ${c.banco||'â€”'}<br><span style="font-family:'DM Mono',monospace;font-size:.65rem;color:var(--muted)">DiferenÃ§a: <strong style="color:var(--red)">R$ ${fmtM(c.diferenca)}</strong> Â· ${c.periodo}</span>`;
}
async function enviar() {
  const inp = document.getElementById('chatIn');
  const txt = inp.value.trim(); if (!txt) return;
  inp.value = '';
  addMsg('u', txt);
  state.chatHistory.push({role:'user',content:txt});
  const thinking = addMsg('ai','<span class="spin"></span>');
  try {
    let resp;
    if (state.apiKey?.startsWith('sk-ant-')) {
      const ctx = state.chatCtx ? `\n\nCASO EM CONTEXTO: ${state.chatCtx.cliente} | ${state.chatCtx.banco} | DiferenÃ§a: R$ ${fmtM(state.chatCtx.diferenca)} | PerÃ­odo: ${state.chatCtx.periodo}` : '';
      const r = await fetch('https://api.anthropic.com/v1/messages',{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'x-api-key':state.apiKey,
          'anthropic-version':'2023-06-01',
          'anthropic-dangerous-direct-browser-ipc':'true'
        },
        body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:700,
          system:`VocÃª Ã© assistente jurÃ­dico especializado em direito bancÃ¡rio brasileiro, anÃ¡lise pericial de conta corrente e cheque especial. Seja tÃ©cnico e objetivo.${ctx}`,
          messages:state.chatHistory})
      });
      const d = await r.json(); resp = d.content[0].text;
    } else { resp = demoResp(txt); }
    state.chatHistory.push({role:'assistant',content:resp});
    thinking.innerHTML = `<div class="msg-lbl">Assistente</div>${resp.replace(/\n/g,'<br>')}`;
  } catch(e) { thinking.innerHTML='Erro: '+e.message; }
}
function addMsg(type, content) {
  const w = document.getElementById('chatMsgs');
  const d = document.createElement('div');
  d.className = 'msg msg-'+(type==='ai'?'ai':'u');
  d.innerHTML = type==='ai'?`<div class="msg-lbl">Assistente</div>${content}`:`<div class="msg-lbl">VocÃª</div>${content}`;
  w.appendChild(d); w.scrollTop=w.scrollHeight; return d;
}
function demoResp(q) {
  if (/anatocismo/i.test(q)) return 'Anatocismo Ã© a capitalizaÃ§Ã£o de juros sobre juros vencidos. Em cheque especial, o banco cobra encargos mensais e, no perÃ­odo seguinte, aplica juros sobre o saldo que jÃ¡ inclui esses encargos â€” configurando capitalizaÃ§Ã£o composta vedada pela SÃºmula 121 do STF. Configure a chave Claude para anÃ¡lise personalizada.';
  if (/20741|bacen|sÃ©rie/i.test(q)) return 'A SÃ©rie 20741 do BACEN divulga mensalmente a taxa mÃ©dia de juros em operaÃ§Ãµes de cheque especial para pessoa fÃ­sica. Ã‰ o teto legal para o recÃ¡lculo dos encargos lÃ­citos. DisponÃ­vel em dadosabertos.bcb.gov.br. O sistema Modus tem as taxas de 2010 a 2024 embutidas.';
  if (/6|seis|hipÃ³tese|compensado/i.test(q)) return 'Os juros compensados consistem em separar, nos saldos devedores, o principal dos juros acumulados. As 6 hipÃ³teses tratam de diferentes combinaÃ§Ãµes de crÃ©ditos e dÃ©bitos no mesmo dia do lanÃ§amento dos encargos â€” determinando se o crÃ©dito quita parcial ou integralmente os juros acumulados, ou se estes se incorporam ao principal.';
  if (/prescri/i.test(q)) return 'O STJ pacificou: 10 anos (art. 205 CC) para a pretensÃ£o revisional de clÃ¡usula contratual; 3 anos (art. 206 Â§3Â° IV CC) para repetiÃ§Ã£o de parcelas vencidas. O marco inicial Ã© a data do pagamento de cada parcela â€” importante para calcular quais meses ainda estÃ£o dentro do prazo.';
  return 'Para respostas detalhadas e anÃ¡lise do seu caso especÃ­fico, configure sua chave de API Claude no campo no topo da tela. Posso ajudar com qualquer questÃ£o de direito bancÃ¡rio ou metodologia pericial.';
}
function setSugg(el) { document.getElementById('chatIn').value = el.textContent; document.getElementById('chatIn').focus(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function delay(ms) { return new Promise(r=>setTimeout(r,ms)); }
function toast(msg, type='') {
  const t=document.createElement('div'); t.className='toast '+(type==='err'?'err':type==='ok'?'ok':'');
  t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),4000);
}

// INIT
renderSidebar();
renderDash();
</script>
</body>
</html>
